<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="" xml:lang="">
<head>
  <meta charset="utf-8" />
  <meta name="generator" content="pandoc" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes" />
  <meta name="author" content="Johan Hidding" />
  <title>Entangled Python module</title>
  <style type="text/css">
      code{white-space: pre-wrap;}
      span.smallcaps{font-variant: small-caps;}
      span.underline{text-decoration: underline;}
      div.column{display: inline-block; vertical-align: top; width: 50%;}
  </style>
  <style type="text/css">
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {  background-color: #f8f8f8; }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ef2929; } /* Alert */
code span.an { color: #8f5902; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #c4a000; } /* Attribute */
code span.bn { color: #0000cf; } /* BaseN */
code span.cf { color: #204a87; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4e9a06; } /* Char */
code span.cn { color: #000000; } /* Constant */
code span.co { color: #8f5902; font-style: italic; } /* Comment */
code span.cv { color: #8f5902; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #8f5902; font-weight: bold; font-style: italic; } /* Documentation */
code span.dt { color: #204a87; } /* DataType */
code span.dv { color: #0000cf; } /* DecVal */
code span.er { color: #a40000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #0000cf; } /* Float */
code span.fu { color: #000000; } /* Function */
code span.im { } /* Import */
code span.in { color: #8f5902; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #204a87; font-weight: bold; } /* Keyword */
code span.op { color: #ce5c00; font-weight: bold; } /* Operator */
code span.ot { color: #8f5902; } /* Other */
code span.pp { color: #8f5902; font-style: italic; } /* Preprocessor */
code span.sc { color: #000000; } /* SpecialChar */
code span.ss { color: #4e9a06; } /* SpecialString */
code span.st { color: #4e9a06; } /* String */
code span.va { color: #000000; } /* Variable */
code span.vs { color: #4e9a06; } /* VerbatimString */
code span.wa { color: #8f5902; font-weight: bold; font-style: italic; } /* Warning */
  </style>
  <!-- Bootstrap 4.5.0 stylesheet -->
  <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.0/css/bootstrap.min.css" integrity="sha384-9aIt2nRpC12Uk9gS9baDl411NQApFmC26EwAOH8WgZl5MYYxFfc+NcPb1dKGj7Sk" crossorigin="anonymous">
  <link rel="stylesheet" href="css/mods.css" />
  <!--[if lt IE 9]>
    <script src="//cdnjs.cloudflare.com/ajax/libs/html5shiv/3.7.3/html5shiv-printshiv.min.js"></script>
  <![endif]-->
<!-- <script data-main="scripts/main" src="js/require.js"></script> -->
  <!-- Load React. -->
  <!-- Note: when deploying, replace "development.js" with "production.min.js". -->
<!--  <script src="https://unpkg.com/react@16/umd/react.development.js" crossorigin></script>
  <script src="https://unpkg.com/react-dom@16/umd/react-dom.development.js" crossorigin></script> -->


</head>
<body class="d-flex flex-column">

<nav id="TOC" class="navbar navbar-dark bg-dark">
  <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
    <span class="navbar-toggler-icon"></span>
  </button>
  <a href="#" class="ml-5 mr-auto navbar-brand">Entangled Python module<br><span style="font-size: smaller"> by <i>Johan Hidding</i></span></a>
<div class="collapse navbar-collapse" id="navbarSupportedContent">
<ul>
<li><a href="#readme-entangled-pandoc-filters">Readme – Entangled, Pandoc filters</a></li>
<li><a href="#config">Config</a></li>
<li><a href="#panflute">Panflute</a></li>
<li><a href="#tangle">Tangle</a></li>
<li><a href="#code-block-annotation">Code block annotation</a></li>
<li><a href="#doctesting">Doctesting</a></li>
<li><a href="#bootstrap">Bootstrap</a></li>
</ul>
</div>
</nav>

<!-- <nav class="navbar navbar-dark navbar-expand-md bg-dark mb-4">
<p class="author">Johan Hidding</p>
</nav>
 -->

<main role="main" class="flex-fill"><div class="container my-5">
<div class="container-fluid my-4">
<div class="card-deck">
<div class="col">
<div class="card h-100 rounded-lg">
<img src="literate.jpg" title="Literate Programming" class="card-img-top" />
<div class="card-body d-flex flex-column">
<h3 class="card-title">Literate Programming</h3>
<div class="card-text">
<p>Write prose and code intermixed. This works great for scientific software, tutorials, or any other software.</p>
</div>
<a href="http://entangled.github.io/" class="btn btn-secondary mt-auto mx-4">About Entangled</a>
</div>
</div>
</div>
<div class="col">
<div class="card h-100 rounded-lg">
<img src="bootstrap.jpg" title="Bootstrap" class="card-img-top" />
<div class="card-body d-flex flex-column">
<h3 class="card-title">Bootstrap</h3>
<div class="card-text">
<p>Generate pretty Bootstrap websites. Your Markdown is translated to a snappy responsive website.</p>
</div>
<a href="https://getbootstrap.com/" class="btn btn-secondary mt-auto mx-4">About Bootstrap</a>
</div>
</div>
</div>
<div class="col">
<div class="card h-100 rounded-lg">
<img src="jupiter.jpg" title="Jupyter" class="card-img-top" />
<div class="card-body d-flex flex-column">
<h3 class="card-title">Jupyter</h3>
<div class="card-text">
<p>Use Jupyter to evaluate code snippets on the fly. Great for writing documentation.</p>
</div>
<a href="https://jupyter.org/" class="btn btn-secondary mt-auto mx-4">About Jupyter</a>
</div>
</div>
</div>
</div>
</div>
<p>This is a set of Pandoc filters for literate programming written in Python. These filters are part of Entangled. They constitute a complete workflow for literate programming on them selves, but it is advised to use them in conjunction with Entangled.</p>
<p>In particular, while you can tangle source files with the <code>entangled.tangle</code> Python module, it is much more convenient to use the <code>entangled</code> executable, which automatically tangles files upon saving the Markdown files, and more importantly, also does the reverse, keeping your files continuously in sync.</p>
<p>This module also acts as a test-bed and environment for rapid prototyping of features that may end up in the main (Haskell based part of) Entangled distribution. Currently we have:</p>
<ul>
<li><code>tangle</code>, extract source files from embedded code blocks in Markdown.</li>
<li><code>annotate</code>, add name tags to code blocks.</li>
<li><code>doctest</code>, run documentation tests through Jupyter.</li>
<li><code>bootstrap</code>, expand some elements into Bootstrap widgets.</li>
</ul>
<h2 id="version">Version</h2>
<div class="annotated-code">
<p><span><em>«entangled/__init__.py»=</em></span></p>
<div class="sourceCode" id="cb1" data-file="entangled/__init__.py"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb1-1"><a href="#cb1-1"></a>__version__ <span class="op">=</span> <span class="st">&quot;0.6.0&quot;</span></span></code></pre></div>
</div>
<h2 id="demo">Demo</h2>
<ul>
<li><p>This page uses the very same pandoc filters it implements. On the top you see a rendering of a Bootstrap card-deck. This deck is generated from a code block containing the Dhall description of the content.</p></li>
<li><p>Sometimes, when you write literate code it cannot be avoided that you have to implement some boring stuff that doesn’t warrant a detailed explanation. In this case you can collapse a code block behind a button.</p></li>
</ul>
<div class="fold-block">
<button class="btn btn-outline-primary btn-sm fold-toggle" type="button" data-toggle="collapse" data-target="#compute-pi-container" aria-controls="compute-pi-container">&lt;&lt;compute-pi&gt;&gt;=</button>
<div id="compute-pi-container" class="collapse">
<div class="sourceCode" id="compute-pi" style="max-height: 50vh"><pre class="sourceCode python bootstrap-fold overflow-auto"><code class="sourceCode python"><span id="compute-pi-1"><a href="#compute-pi-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="compute-pi-2"><a href="#compute-pi-2"></a></span>
<span id="compute-pi-3"><a href="#compute-pi-3"></a><span class="kw">def</span> compute_pi(sample_size):</span>
<span id="compute-pi-4"><a href="#compute-pi-4"></a>    points <span class="op">=</span> np.random.uniform(<span class="dv">0</span>, <span class="dv">1</span>, size<span class="op">=</span>[sample_size, <span class="dv">2</span>])</span>
<span id="compute-pi-5"><a href="#compute-pi-5"></a>    within_circle <span class="op">=</span> np.count_nonzero((points<span class="op">**</span><span class="dv">2</span>).<span class="bu">sum</span>(axis<span class="op">=</span><span class="dv">1</span>) <span class="op">&lt;=</span> <span class="fl">1.0</span>)</span>
<span id="compute-pi-6"><a href="#compute-pi-6"></a>    <span class="cf">return</span> <span class="dv">4</span> <span class="op">*</span> within_circle <span class="op">/</span> sample_size</span></code></pre></div>
</div>
</div>
<ul>
<li>If you’re documenting a library you may want to have code blocks evaluated inline.</li>
</ul>
<div class="annotated-code">
<p><span><em>«compute-pi»=</em></span></p>
<div class="doctest" data-status="SUCCESS">
<div class="doctestInput">
<div class="sourceCode" id="compute-pi"><pre class="sourceCode python eval"><code class="sourceCode python"><span id="compute-pi-1"><a href="#compute-pi-1"></a><span class="bu">print</span>(<span class="st">&quot;π ≈ </span><span class="sc">{}</span><span class="st">&quot;</span>.<span class="bu">format</span>(compute_pi(<span class="dv">1000000</span>)))</span></code></pre></div>
</div>
<div class="doctestResult">
<div class="sourceCode" id="cb2"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb2-1"><a href="#cb2-1"></a>π ≈ <span class="fl">3.143336</span></span></code></pre></div>
</div>
</div>
</div>
<h1 id="readme-entangled-pandoc-filters">Readme – Entangled, Pandoc filters</h1>
<p><a href="https://github.com/entangled/filters/actions?query=workflow%3ATests"><img src="https://github.com/entangled/filters/workflows/Tests/badge.svg" alt="Test Badge" /></a> <a href="https://codecov.io/gh/entangled/filters"><img src="https://codecov.io/gh/entangled/filters/branch/master/graph/badge.svg" alt="codecov" /></a></p>
<p>This contains several Pandoc filters and scripts for literate programming in Markdown. These filters are enough to get you going with literate programming using Pandoc.</p>
<table>
<colgroup>
<col style="width: 35%" />
<col style="width: 64%" />
</colgroup>
<thead>
<tr class="header">
<th>Filter</th>
<th>Function</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><code>pandoc-annotate-codeblocks</code></td>
<td>Adds annotation to code blocks in the woven output.</td>
</tr>
<tr class="even">
<td><code>pandoc-doctest</code></td>
<td>Runs doc-tests by passing the content of code blocks through Jupyter.</td>
</tr>
<tr class="odd">
<td><code>pandoc-tangle</code></td>
<td>Generate source files from the content of code blocks.</td>
</tr>
<tr class="even">
<td><code>pandoc-bootstrap</code></td>
<td>Expand some elements specifically targeting a Bootstrap page.</td>
</tr>
</tbody>
</table>
<h2 id="install">Install</h2>
<p>Entangled filters has the following prerequisites:</p>
<ul>
<li><strong>Python &gt;=3.7</strong>: All of these filters are written in Python. This is mainly to encourage as many users (<strong>I mean YOU</strong>) to start developing Pandoc filters.</li>
<li><strong>Dhall</strong>: the <code>pandoc-bootstrap</code> filter requires <code>dhall-to-json</code> to be installed: see <a href="https://dhall-lang.org/">Dhall language</a>. TLDR: download <code>dhall-json-*-[windows|macos|linux].[zip|tar.bz2]</code> from the <a href="https://github.com/dhall-lang/dhall-haskell/releases">Dhall release page</a>, and extract it to a location in your <code>$PATH</code>. Dhall is awesome, it <em>will</em> make your life better.</li>
</ul>
<p>Installation is easiest using <code>pip</code>,</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb3-1"><a href="#cb3-1"></a><span class="ex">pip</span> install entangled-filters</span></code></pre></div>
<h3 id="for-development">For development</h3>
<p>To run tests, after doing a normal install (to get the executables installed), run</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb4-1"><a href="#cb4-1"></a><span class="ex">pip</span> install --upgrade -e .[test]</span>
<span id="cb4-2"><a href="#cb4-2"></a><span class="ex">pytest</span></span></code></pre></div>
<p>The executables are auto-generated by the <code>setup.py</code> script and call some <code>python -m</code> command.</p>
<h2 id="supported-syntax">Supported syntax</h2>
<p>See the <a href="https://entangled.github.io">project homepage</a> for more info.</p>
<h3 id="named-code-blocks">Named code blocks</h3>
<div class="sourceCode" id="cb5"><pre class="sourceCode markdown"><code class="sourceCode markdown"><span id="cb5-1"><a href="#cb5-1"></a><span class="bn">``` {.python #hello}</span></span>
<span id="cb5-2"><a href="#cb5-2"></a><span class="bn">print(&quot;Hello, World!&quot;)</span></span>
<span id="cb5-3"><a href="#cb5-3"></a><span class="bn">```</span></span></code></pre></div>
<h3 id="reference-code-blocks">Reference code blocks</h3>
<div class="sourceCode" id="cb6"><pre class="sourceCode markdown"><code class="sourceCode markdown"><span id="cb6-1"><a href="#cb6-1"></a><span class="bn">``` {.python #main}</span></span>
<span id="cb6-2"><a href="#cb6-2"></a><span class="bn">def main():</span></span>
<span id="cb6-3"><a href="#cb6-3"></a><span class="bn">    &lt;&lt;hello&gt;&gt;</span></span>
<span id="cb6-4"><a href="#cb6-4"></a><span class="bn">```</span></span></code></pre></div>
<h3 id="define-files">Define files</h3>
<div class="sourceCode" id="cb7"><pre class="sourceCode markdown"><code class="sourceCode markdown"><span id="cb7-1"><a href="#cb7-1"></a><span class="bn">``` {.python file=hello.py}</span></span>
<span id="cb7-2"><a href="#cb7-2"></a><span class="bn">&lt;&lt;main&gt;&gt;</span></span>
<span id="cb7-3"><a href="#cb7-3"></a></span>
<span id="cb7-4"><a href="#cb7-4"></a><span class="bn">if __name__ == &quot;__main__&quot;:</span></span>
<span id="cb7-5"><a href="#cb7-5"></a><span class="bn">    main()</span></span>
<span id="cb7-6"><a href="#cb7-6"></a><span class="bn">```</span></span></code></pre></div>
<h3 id="documentation-tests">Documentation tests</h3>
<div class="sourceCode" id="cb8"><pre class="sourceCode markdown"><code class="sourceCode markdown"><span id="cb8-1"><a href="#cb8-1"></a><span class="bn">``` {.python .doctest #the-question}</span></span>
<span id="cb8-2"><a href="#cb8-2"></a><span class="bn">6*7</span></span>
<span id="cb8-3"><a href="#cb8-3"></a><span class="bn">---</span></span>
<span id="cb8-4"><a href="#cb8-4"></a><span class="bn">42</span></span>
<span id="cb8-5"><a href="#cb8-5"></a><span class="bn">```</span></span></code></pre></div>
<h2 id="pandoc-tangle"><code>pandoc-tangle</code></h2>
<p>Extracts code blocks and writes them to files.</p>
<pre class="shell"><code>pandoc -t plain --filter pandoc-tangle hello.md</code></pre>
<h2 id="pandoc-annotate-codeblocks"><code>pandoc-annotate-codeblocks</code></h2>
<p>Annotates code blocks in generated HTML or PDF output with name tags.</p>
<pre class="shell"><code>pandoc -t html5 -s --filter pandoc-anotate-codeblocks hello.md</code></pre>
<h2 id="pandoc-doctest"><code>pandoc-doctest</code></h2>
<p>Runs doctests, and include results into output. Also annotates the code blocks (so no need to run <code>pandoc-annotate-codeblocks</code>).</p>
<pre class="shell"><code>pandoc -t html5 -s --filter pandoc-doctest hello.md</code></pre>
<h2 id="pandoc-bootstrap"><code>pandoc-bootstrap</code></h2>
<p>Also annotates code blocks, and has two features:</p>
<ul>
<li><p>Expand a Dhall specification into a card deck for Bootstrap, that is a flex-box with a single row and several columns of cards. This is nice to have at the top of a page to draw attention to some key points.</p></li>
<li><p>Collapsible/foldable code blocks. Add a <code>.bootstrap-fold</code> class to a code block to have the code block hidden behind a button. This is nice for some larger uninteresting code.</p></li>
</ul>
<p>This filter should be used together with a Bootstrap template for Pandoc. An example of its use can be seen here: <a href="https://jhidding.github.io/chaotic-pendulum">Chaotic Pendulum</a>, with the source code at <a href="https://github.com/jhidding/chaotic-pendulum">gh:jhidding/chaotic-pendulum</a>.</p>
<h2 id="docker">Docker</h2>
<p>The Entangled pandoc filters is available as a <a href="https://hub.docker.com/repository/docker/nlesc/pandoc-tangle">Docker image</a>.</p>
<h3 id="run">Run</h3>
<p>In your current working directory with a README.md file run</p>
<pre><code>docker run --rm -ti --user $UID -v $PWD:/data nlesc/pandoc-tangle README.md</code></pre>
<p>This will extracts code blocks and writes them to files.</p>
<h3 id="build">Build</h3>
<pre class="shell"><code>docker build -t nlesc/pandoc-tangle .</code></pre>
<h1 id="config">Config</h1>
<p>Configuration of the <code>entangled</code> module is done through a file that should sit in the current directory.</p>
<p>As a configuration format we use <a href="https://dhall-lang.org/"><strong>Dhall</strong></a>, with a fall-back to JSON. The file should be named either <code>entangled.dhall</code> or <code>entangled.json</code>. For the Dhall based configuration to work, you need to have the <code>dhall-to-json</code> executable installed.</p>
<div class="annotated-code">
<p><span><em>«entangled/config.py»=</em></span></p>
<div class="sourceCode" id="cb14" data-file="entangled/config.py"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb14-1"><a href="#cb14-1"></a><span class="im">from</span> .typing <span class="im">import</span> (JSONType)</span>
<span id="cb14-2"><a href="#cb14-2"></a><span class="im">import</span> subprocess</span>
<span id="cb14-3"><a href="#cb14-3"></a><span class="im">import</span> json</span>
<span id="cb14-4"><a href="#cb14-4"></a><span class="im">import</span> sys</span>
<span id="cb14-5"><a href="#cb14-5"></a></span>
<span id="cb14-6"><a href="#cb14-6"></a><span class="kw">def</span> read_config() <span class="op">-&gt;</span> JSONType:</span>
<span id="cb14-7"><a href="#cb14-7"></a>    <span class="co">&quot;&quot;&quot;Reads config from `entangled.dhall` with fall-back to `entangled.json`.&quot;&quot;&quot;</span></span>
<span id="cb14-8"><a href="#cb14-8"></a>    <span class="cf">try</span>:</span>
<span id="cb14-9"><a href="#cb14-9"></a>        result <span class="op">=</span> subprocess.run(</span>
<span id="cb14-10"><a href="#cb14-10"></a>            [<span class="st">&quot;dhall-to-json&quot;</span>, <span class="st">&quot;--file&quot;</span>, <span class="st">&quot;entangled.dhall&quot;</span>],</span>
<span id="cb14-11"><a href="#cb14-11"></a>            stdout<span class="op">=</span>subprocess.PIPE, stderr<span class="op">=</span>subprocess.PIPE, encoding<span class="op">=</span><span class="st">&#39;utf-8&#39;</span>, check<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb14-12"><a href="#cb14-12"></a>        <span class="cf">return</span> json.loads(result.stdout)</span>
<span id="cb14-13"><a href="#cb14-13"></a>    <span class="cf">except</span> subprocess.CalledProcessError <span class="im">as</span> e:</span>
<span id="cb14-14"><a href="#cb14-14"></a>        <span class="bu">print</span>(<span class="st">&quot;Error reading `entangled.dhall`:</span><span class="ch">\n</span><span class="st">&quot;</span> <span class="op">+</span> e.stderr, <span class="bu">file</span><span class="op">=</span>sys.stderr)</span>
<span id="cb14-15"><a href="#cb14-15"></a>    <span class="cf">except</span> <span class="pp">FileNotFoundError</span>:</span>
<span id="cb14-16"><a href="#cb14-16"></a>        <span class="bu">print</span>(<span class="st">&quot;Warning: could not find `dhall-to-json`, trying to read JSON instead.&quot;</span>,</span>
<span id="cb14-17"><a href="#cb14-17"></a>              <span class="bu">file</span><span class="op">=</span>sys.stderr)</span>
<span id="cb14-18"><a href="#cb14-18"></a>    <span class="cf">return</span> json.load(<span class="bu">open</span>(<span class="st">&quot;entangled.json&quot;</span>, <span class="st">&quot;r&quot;</span>))</span>
<span id="cb14-19"><a href="#cb14-19"></a></span>
<span id="cb14-20"><a href="#cb14-20"></a><span class="kw">def</span> get_language_info(config: JSONType, identifier: <span class="bu">str</span>) <span class="op">-&gt;</span> JSONType:</span>
<span id="cb14-21"><a href="#cb14-21"></a>    kernels <span class="op">=</span> { k[<span class="st">&quot;language&quot;</span>]: k[<span class="st">&quot;kernel&quot;</span>] <span class="cf">for</span> k <span class="kw">in</span> config[<span class="st">&quot;jupyter&quot;</span>] }</span>
<span id="cb14-22"><a href="#cb14-22"></a></span>
<span id="cb14-23"><a href="#cb14-23"></a>    <span class="cf">try</span>:</span>
<span id="cb14-24"><a href="#cb14-24"></a>        language <span class="op">=</span> <span class="bu">next</span>(lang <span class="cf">for</span> lang <span class="kw">in</span> config[<span class="st">&quot;entangled&quot;</span>][<span class="st">&quot;languages&quot;</span>]</span>
<span id="cb14-25"><a href="#cb14-25"></a>                        <span class="cf">if</span> identifier <span class="kw">in</span> lang[<span class="st">&quot;identifiers&quot;</span>])</span>
<span id="cb14-26"><a href="#cb14-26"></a>    <span class="cf">except</span> <span class="pp">StopIteration</span>:</span>
<span id="cb14-27"><a href="#cb14-27"></a>        <span class="cf">raise</span> <span class="pp">ValueError</span>(<span class="ss">f&quot;Language with identifier `</span><span class="sc">{</span>identifier<span class="sc">}</span><span class="ss">` not found in config.&quot;</span>)</span>
<span id="cb14-28"><a href="#cb14-28"></a></span>
<span id="cb14-29"><a href="#cb14-29"></a>    <span class="cf">return</span> {<span class="st">&quot;jupyter&quot;</span>: kernels.get(language[<span class="st">&quot;name&quot;</span>]), <span class="op">**</span>language}</span></code></pre></div>
</div>
<h1 id="panflute">Panflute</h1>
<p>Panflute reads JSON from standard input, lets you apply filters to an intermediate object based representation and writes back to JSON. The actual filtering is done by a Panflute <code>Action</code>. The action takes an <code>Element</code> and a <code>Document</code> as argument and can return one of three things:</p>
<ul>
<li><code>None</code>, leaves the element unchanged</li>
<li><code>Element</code>, replaces the element</li>
<li><code>List[Element]</code>, splices the list into list that contained the element</li>
</ul>
<p>These are some types that we can use for type annotations.</p>
<div class="annotated-code">
<p><span><em>«entangled/typing.py»=</em></span></p>
<div class="sourceCode" id="cb15" data-file="entangled/typing.py"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb15-1"><a href="#cb15-1"></a><span class="im">from</span> typing <span class="im">import</span> (Union, List, Dict, Callable, Any)</span>
<span id="cb15-2"><a href="#cb15-2"></a><span class="im">from</span> panflute <span class="im">import</span> (Element, Doc, CodeBlock)</span>
<span id="cb15-3"><a href="#cb15-3"></a></span>
<span id="cb15-4"><a href="#cb15-4"></a>ActionReturn <span class="op">=</span> Union[Element, List[Element], <span class="va">None</span>]</span>
<span id="cb15-5"><a href="#cb15-5"></a>Action <span class="op">=</span> Callable[[Element, Doc], ActionReturn]</span>
<span id="cb15-6"><a href="#cb15-6"></a>CodeMap <span class="op">=</span> Dict[<span class="bu">str</span>, List[CodeBlock]]</span>
<span id="cb15-7"><a href="#cb15-7"></a>JSONType <span class="op">=</span> Any</span></code></pre></div>
</div>
<h1 id="tangle">Tangle</h1>
<p>The global structure of a filter in <code>panflute</code> runs <code>run_filter</code> from a <code>main</code> function. We’ll keep a global registry of all code-blocks entered. In <code>panflute</code> a global variable is passed on top of the <code>doc</code> parameter that is passed to all involved functions.</p>
<div class="annotated-code">
<p><span><em>«entangled/tangle.py»=</em></span></p>
<div class="sourceCode" id="cb16" data-file="entangled/tangle.py"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb16-1"><a href="#cb16-1"></a><span class="im">from</span> panflute <span class="im">import</span> (run_filter, Doc, Element, CodeBlock)</span>
<span id="cb16-2"><a href="#cb16-2"></a><span class="im">from</span> typing <span class="im">import</span> (Optional, Dict, Callable)</span>
<span id="cb16-3"><a href="#cb16-3"></a><span class="im">from</span> .typing <span class="im">import</span> (CodeMap)</span>
<span id="cb16-4"><a href="#cb16-4"></a><span class="im">import</span> sys</span>
<span id="cb16-5"><a href="#cb16-5"></a></span>
<span id="cb16-6"><a href="#cb16-6"></a><span class="op">&lt;&lt;</span>get<span class="op">-</span>code<span class="op">-</span>block<span class="op">&gt;&gt;</span></span>
<span id="cb16-7"><a href="#cb16-7"></a></span>
<span id="cb16-8"><a href="#cb16-8"></a><span class="op">&lt;&lt;</span>tangle<span class="op">-</span>prepare<span class="op">&gt;&gt;</span></span>
<span id="cb16-9"><a href="#cb16-9"></a><span class="op">&lt;&lt;</span>tangle<span class="op">-</span>action<span class="op">&gt;&gt;</span></span>
<span id="cb16-10"><a href="#cb16-10"></a><span class="op">&lt;&lt;</span>tangle<span class="op">-</span>finalize<span class="op">&gt;&gt;</span></span>
<span id="cb16-11"><a href="#cb16-11"></a></span>
<span id="cb16-12"><a href="#cb16-12"></a><span class="kw">def</span> main(doc: Optional[Doc] <span class="op">=</span> <span class="va">None</span>) <span class="op">-&gt;</span> <span class="va">None</span>:</span>
<span id="cb16-13"><a href="#cb16-13"></a>    run_filter(</span>
<span id="cb16-14"><a href="#cb16-14"></a>        action, prepare<span class="op">=</span>prepare, finalize<span class="op">=</span>finalize, doc<span class="op">=</span>doc)</span></code></pre></div>
</div>
<p>We prepare a global variable <code>doc.codes</code> with a <code>defaultdict</code> for empty lists.</p>
<div class="annotated-code">
<p><span><em>«tangle-prepare»=</em></span></p>
<div class="sourceCode" id="tangle-prepare"><pre class="sourceCode python"><code class="sourceCode python"><span id="tangle-prepare-1"><a href="#tangle-prepare-1"></a><span class="im">from</span> collections <span class="im">import</span> defaultdict</span>
<span id="tangle-prepare-2"><a href="#tangle-prepare-2"></a></span>
<span id="tangle-prepare-3"><a href="#tangle-prepare-3"></a><span class="kw">def</span> prepare(doc: Doc) <span class="op">-&gt;</span> <span class="va">None</span>:</span>
<span id="tangle-prepare-4"><a href="#tangle-prepare-4"></a>    doc.code_map <span class="op">=</span> defaultdict(<span class="bu">list</span>)</span></code></pre></div>
</div>
<p>In the action, we store whatever code block we can find a name for.</p>
<div class="annotated-code">
<p><span><em>«tangle-action»=</em></span></p>
<div class="sourceCode" id="tangle-action"><pre class="sourceCode python"><code class="sourceCode python"><span id="tangle-action-1"><a href="#tangle-action-1"></a><span class="op">&lt;&lt;</span>get<span class="op">-</span>name<span class="op">&gt;&gt;</span></span>
<span id="tangle-action-2"><a href="#tangle-action-2"></a></span>
<span id="tangle-action-3"><a href="#tangle-action-3"></a><span class="kw">def</span> action(elem: Element, doc: Doc) <span class="op">-&gt;</span> <span class="va">None</span>:</span>
<span id="tangle-action-4"><a href="#tangle-action-4"></a>    <span class="cf">if</span> <span class="bu">isinstance</span>(elem, CodeBlock):</span>
<span id="tangle-action-5"><a href="#tangle-action-5"></a>        name <span class="op">=</span> get_name(elem)</span>
<span id="tangle-action-6"><a href="#tangle-action-6"></a>        <span class="cf">if</span> name:</span>
<span id="tangle-action-7"><a href="#tangle-action-7"></a>            doc.code_map[name].append(elem)</span></code></pre></div>
</div>
<p>In the finalisation we need to expand code blocks, and run those blocks that are marked as <code>.doctest</code>.</p>
<h3 id="getting-a-name">Getting a name</h3>
<p>If the code block contains an identifier, that is used as the name. Alternatively, if a the code-block has an attribute <code>file=...</code>, the given filename is used as a name.</p>
<div class="annotated-code">
<p><span><em>«get-name»=</em></span></p>
<div class="sourceCode" id="get-name"><pre class="sourceCode python"><code class="sourceCode python"><span id="get-name-1"><a href="#get-name-1"></a><span class="kw">def</span> get_name(elem: Element) <span class="op">-&gt;</span> Optional[<span class="bu">str</span>]:</span>
<span id="get-name-2"><a href="#get-name-2"></a>    <span class="cf">if</span> elem.identifier:</span>
<span id="get-name-3"><a href="#get-name-3"></a>        <span class="cf">return</span> elem.identifier</span>
<span id="get-name-4"><a href="#get-name-4"></a></span>
<span id="get-name-5"><a href="#get-name-5"></a>    <span class="cf">if</span> <span class="st">&quot;file&quot;</span> <span class="kw">in</span> elem.attributes:</span>
<span id="get-name-6"><a href="#get-name-6"></a>        <span class="cf">return</span> elem.attributes[<span class="st">&quot;file&quot;</span>]</span>
<span id="get-name-7"><a href="#get-name-7"></a></span>
<span id="get-name-8"><a href="#get-name-8"></a>    <span class="cf">return</span> <span class="va">None</span></span></code></pre></div>
</div>
<h2 id="expand-code-references">Expand code references</h2>
<p>To expand code references we match a regular expression with a reference line. Every reference is then replaced with the expanded code block matching it. This is implemented as a doubly recursive function.</p>
<div class="annotated-code">
<p><span><em>«get-code-block»=</em></span></p>
<div class="sourceCode" id="get-code-block"><pre class="sourceCode python"><code class="sourceCode python"><span id="get-code-block-1"><a href="#get-code-block-1"></a><span class="im">import</span> re</span>
<span id="get-code-block-2"><a href="#get-code-block-2"></a></span>
<span id="get-code-block-3"><a href="#get-code-block-3"></a><span class="op">&lt;&lt;</span>replace<span class="op">-</span>expr<span class="op">&gt;&gt;</span></span>
<span id="get-code-block-4"><a href="#get-code-block-4"></a></span>
<span id="get-code-block-5"><a href="#get-code-block-5"></a><span class="kw">def</span> get_code(code_map: CodeMap, name: <span class="bu">str</span>) <span class="op">-&gt;</span> <span class="bu">str</span>:</span>
<span id="get-code-block-6"><a href="#get-code-block-6"></a>    <span class="op">&lt;&lt;</span>expand<span class="op">&gt;&gt;</span></span>
<span id="get-code-block-7"><a href="#get-code-block-7"></a>    <span class="op">&lt;&lt;</span>look<span class="op">-</span>up<span class="op">&gt;&gt;</span></span>
<span id="get-code-block-8"><a href="#get-code-block-8"></a>    <span class="cf">return</span> look_up(name<span class="op">=</span>name, prefix<span class="op">=</span><span class="st">&quot;&quot;</span>)</span>
<span id="get-code-block-9"><a href="#get-code-block-9"></a></span>
<span id="get-code-block-10"><a href="#get-code-block-10"></a><span class="kw">def</span> expand_code_block(code_map: CodeMap, code_block: CodeBlock) <span class="op">-&gt;</span> <span class="bu">str</span>:</span>
<span id="get-code-block-11"><a href="#get-code-block-11"></a>    <span class="op">&lt;&lt;</span>expand<span class="op">&gt;&gt;</span></span>
<span id="get-code-block-12"><a href="#get-code-block-12"></a>    <span class="op">&lt;&lt;</span>look<span class="op">-</span>up<span class="op">&gt;&gt;</span></span>
<span id="get-code-block-13"><a href="#get-code-block-13"></a>    <span class="cf">return</span> expand(code_block)</span></code></pre></div>
</div>
<p>The <code>replace_expr</code> function does one of two things. If the input is not a match, the input is returned unchanged. If it is a match, all named sub-matches are taken out and given as keyword argument to the given <code>replace</code> function, the result of which is returned.</p>
<div class="annotated-code">
<p><span><em>«replace-expr»=</em></span></p>
<div class="sourceCode" id="replace-expr"><pre class="sourceCode python"><code class="sourceCode python"><span id="replace-expr-1"><a href="#replace-expr-1"></a><span class="kw">def</span> replace_expr(expr: <span class="bu">str</span>, replace: Callable[..., <span class="bu">str</span>], text: <span class="bu">str</span>) <span class="op">-&gt;</span> <span class="bu">str</span>:</span>
<span id="replace-expr-2"><a href="#replace-expr-2"></a>    <span class="co">&quot;&quot;&quot;Matches (fullmatch) `text` using the expression `expr`. If the expression</span></span>
<span id="replace-expr-3"><a href="#replace-expr-3"></a><span class="co">    matches, then returns the result of passing named sub-matches as</span></span>
<span id="replace-expr-4"><a href="#replace-expr-4"></a><span class="co">    keyword arguments to `replace`. Returns `text` otherwise.&quot;&quot;&quot;</span></span>
<span id="replace-expr-5"><a href="#replace-expr-5"></a>    match <span class="op">=</span> re.fullmatch(expr, text)</span>
<span id="replace-expr-6"><a href="#replace-expr-6"></a>    <span class="cf">if</span> match:</span>
<span id="replace-expr-7"><a href="#replace-expr-7"></a>        <span class="cf">return</span> replace(<span class="op">**</span>match.groupdict())</span>
<span id="replace-expr-8"><a href="#replace-expr-8"></a>    <span class="cf">else</span>:</span>
<span id="replace-expr-9"><a href="#replace-expr-9"></a>        <span class="cf">return</span> text</span></code></pre></div>
</div>
<p>In our case the <code>replace</code> function is called <code>look_up</code>; it looks up the given name and indents the result with a given prefix.</p>
<div class="annotated-code">
<p><span><em>«look-up»=</em></span></p>
<div class="sourceCode" id="look-up"><pre class="sourceCode python"><code class="sourceCode python"><span id="look-up-1"><a href="#look-up-1"></a><span class="im">from</span> textwrap <span class="im">import</span> indent</span>
<span id="look-up-2"><a href="#look-up-2"></a></span>
<span id="look-up-3"><a href="#look-up-3"></a><span class="kw">def</span> look_up(<span class="op">*</span>, name: <span class="bu">str</span>, prefix: <span class="bu">str</span>) <span class="op">-&gt;</span> <span class="bu">str</span>:</span>
<span id="look-up-4"><a href="#look-up-4"></a>    blocks <span class="op">=</span> code_map[name]</span>
<span id="look-up-5"><a href="#look-up-5"></a>    <span class="cf">if</span> <span class="kw">not</span> blocks:</span>
<span id="look-up-6"><a href="#look-up-6"></a>        <span class="cf">raise</span> <span class="pp">ValueError</span>(<span class="ss">f&quot;No code with name `</span><span class="sc">{</span>name<span class="sc">}</span><span class="ss">` found.&quot;</span>)</span>
<span id="look-up-7"><a href="#look-up-7"></a>    result <span class="op">=</span> <span class="st">&quot;</span><span class="ch">\n</span><span class="st">&quot;</span>.join(expand(code) <span class="cf">for</span> code <span class="kw">in</span> blocks)</span>
<span id="look-up-8"><a href="#look-up-8"></a>    <span class="cf">return</span> indent(result, prefix)</span></code></pre></div>
</div>
<p>The function <code>expand</code> takes a <code>CodeBlock</code> object and expands all references using the given regex. Decomposing this particular regex:</p>
<ul>
<li><code>(?P&lt;prefix&gt;[ \t]*)</code> matches the indentation, either tabs or spaces.</li>
<li><code>&lt;&lt;(?P&lt;name&gt;[^ &gt;]*)&gt;&gt;</code> matches the named reference, surrounded by <code>&lt;&lt;...&gt;&gt;</code>.</li>
<li><code>\Z</code> matches the end of input.</li>
</ul>
<div class="annotated-code">
<p><span><em>«expand»=</em></span></p>
<div class="sourceCode" id="expand"><pre class="sourceCode python"><code class="sourceCode python"><span id="expand-1"><a href="#expand-1"></a><span class="kw">def</span> expand(code: CodeBlock) <span class="op">-&gt;</span> <span class="bu">str</span>:</span>
<span id="expand-2"><a href="#expand-2"></a>    pattern <span class="op">=</span> <span class="st">&quot;(?P&lt;prefix&gt;[ </span><span class="ch">\t</span><span class="st">]*)&lt;&lt;(?P&lt;name&gt;[^ &gt;]*)&gt;&gt;</span><span class="ch">\\</span><span class="st">Z&quot;</span></span>
<span id="expand-3"><a href="#expand-3"></a>    <span class="cf">return</span> <span class="st">&quot;</span><span class="ch">\n</span><span class="st">&quot;</span>.join(</span>
<span id="expand-4"><a href="#expand-4"></a>        replace_expr(pattern, look_up, line)</span>
<span id="expand-5"><a href="#expand-5"></a>        <span class="cf">for</span> line <span class="kw">in</span> code.text.splitlines())</span></code></pre></div>
</div>
<p>Together, <code>expand</code> and <code>look_up</code> form a doubly recursive pair of functions, evaluating the contents of any code block found in the input.</p>
<h2 id="finalize">Finalize</h2>
<p>To finalize, we write out all files that we can find.</p>
<div class="annotated-code">
<p><span><em>«tangle-finalize»=</em></span></p>
<div class="sourceCode" id="tangle-finalize"><pre class="sourceCode python"><code class="sourceCode python"><span id="tangle-finalize-1"><a href="#tangle-finalize-1"></a><span class="kw">def</span> get_file_map(code_map: CodeMap) <span class="op">-&gt;</span> Dict[<span class="bu">str</span>, <span class="bu">str</span>]:</span>
<span id="tangle-finalize-2"><a href="#tangle-finalize-2"></a>    <span class="co">&quot;&quot;&quot;Extracts all file references from `code_map`.&quot;&quot;&quot;</span></span>
<span id="tangle-finalize-3"><a href="#tangle-finalize-3"></a>    <span class="cf">return</span> { code[<span class="dv">0</span>].attributes[<span class="st">&quot;file&quot;</span>]: codename </span>
<span id="tangle-finalize-4"><a href="#tangle-finalize-4"></a>             <span class="cf">for</span> codename, code <span class="kw">in</span> code_map.items()</span>
<span id="tangle-finalize-5"><a href="#tangle-finalize-5"></a>             <span class="cf">if</span> <span class="st">&quot;file&quot;</span> <span class="kw">in</span> code[<span class="dv">0</span>].attributes }</span></code></pre></div>
</div>
<p>Only files that are different from those on disk should be overwritten.</p>
<div class="annotated-code">
<p><span><em>«tangle-finalize»+</em></span></p>
<div class="sourceCode" id="tangle-finalize"><pre class="sourceCode python"><code class="sourceCode python"><span id="tangle-finalize-1"><a href="#tangle-finalize-1"></a><span class="kw">def</span> write_file(filename: <span class="bu">str</span>, text: <span class="bu">str</span>) <span class="op">-&gt;</span> <span class="va">None</span>:</span>
<span id="tangle-finalize-2"><a href="#tangle-finalize-2"></a>    <span class="co">&quot;&quot;&quot;Writes `text` to file `filename`, only if `text` is different</span></span>
<span id="tangle-finalize-3"><a href="#tangle-finalize-3"></a><span class="co">    from contents of `filename`.&quot;&quot;&quot;</span></span>
<span id="tangle-finalize-4"><a href="#tangle-finalize-4"></a>    <span class="cf">try</span>:</span>
<span id="tangle-finalize-5"><a href="#tangle-finalize-5"></a>        content <span class="op">=</span> <span class="bu">open</span>(filename).read()</span>
<span id="tangle-finalize-6"><a href="#tangle-finalize-6"></a>        <span class="cf">if</span> content <span class="op">==</span> text:</span>
<span id="tangle-finalize-7"><a href="#tangle-finalize-7"></a>            <span class="cf">return</span></span>
<span id="tangle-finalize-8"><a href="#tangle-finalize-8"></a>    <span class="cf">except</span> <span class="pp">FileNotFoundError</span>:</span>
<span id="tangle-finalize-9"><a href="#tangle-finalize-9"></a>        <span class="cf">pass</span></span>
<span id="tangle-finalize-10"><a href="#tangle-finalize-10"></a>    <span class="bu">print</span>(<span class="ss">f&quot;Writing `</span><span class="sc">{</span>filename<span class="sc">}</span><span class="ss">`.&quot;</span>, <span class="bu">file</span><span class="op">=</span>sys.stderr)</span>
<span id="tangle-finalize-11"><a href="#tangle-finalize-11"></a>    <span class="bu">open</span>(filename, <span class="st">&#39;w&#39;</span>).write(text)</span>
<span id="tangle-finalize-12"><a href="#tangle-finalize-12"></a></span>
<span id="tangle-finalize-13"><a href="#tangle-finalize-13"></a><span class="kw">def</span> finalize(doc: Doc) <span class="op">-&gt;</span> <span class="va">None</span>:</span>
<span id="tangle-finalize-14"><a href="#tangle-finalize-14"></a>    <span class="co">&quot;&quot;&quot;Writes all file references found in `doc.code_map` to disk.</span></span>
<span id="tangle-finalize-15"><a href="#tangle-finalize-15"></a><span class="co">    This only overwrites a file if the content is different.&quot;&quot;&quot;</span></span>
<span id="tangle-finalize-16"><a href="#tangle-finalize-16"></a>    file_map <span class="op">=</span> get_file_map(doc.code_map)</span>
<span id="tangle-finalize-17"><a href="#tangle-finalize-17"></a>    <span class="cf">for</span> filename, codename <span class="kw">in</span> file_map.items():</span>
<span id="tangle-finalize-18"><a href="#tangle-finalize-18"></a>        write_file(filename, get_code(doc.code_map, codename))</span>
<span id="tangle-finalize-19"><a href="#tangle-finalize-19"></a>    doc.content <span class="op">=</span> []</span></code></pre></div>
</div>
<h1 id="code-block-annotation">Code block annotation</h1>
<p>This adds the name of a code block to the output.</p>
<div class="annotated-code">
<p><span><em>«entangled/annotate.py»=</em></span></p>
<div class="sourceCode" id="cb17" data-file="entangled/annotate.py"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb17-1"><a href="#cb17-1"></a><span class="im">from</span> collections <span class="im">import</span> defaultdict</span>
<span id="cb17-2"><a href="#cb17-2"></a><span class="im">from</span> .tangle <span class="im">import</span> get_name</span>
<span id="cb17-3"><a href="#cb17-3"></a><span class="im">from</span> panflute <span class="im">import</span> (Span, Str, Para, CodeBlock, Div, Emph, Doc, run_filter)</span>
<span id="cb17-4"><a href="#cb17-4"></a><span class="im">from</span> typing <span class="im">import</span> (Optional)</span>
<span id="cb17-5"><a href="#cb17-5"></a></span>
<span id="cb17-6"><a href="#cb17-6"></a><span class="kw">def</span> prepare(doc):</span>
<span id="cb17-7"><a href="#cb17-7"></a>    doc.code_count <span class="op">=</span> defaultdict(<span class="kw">lambda</span>: <span class="dv">0</span>)</span>
<span id="cb17-8"><a href="#cb17-8"></a></span>
<span id="cb17-9"><a href="#cb17-9"></a><span class="kw">def</span> action(elem, doc):</span>
<span id="cb17-10"><a href="#cb17-10"></a>    <span class="cf">if</span> <span class="bu">isinstance</span>(elem, CodeBlock):</span>
<span id="cb17-11"><a href="#cb17-11"></a>        name <span class="op">=</span> get_name(elem)</span>
<span id="cb17-12"><a href="#cb17-12"></a>        <span class="cf">if</span> name <span class="kw">is</span> <span class="va">None</span>:</span>
<span id="cb17-13"><a href="#cb17-13"></a>            <span class="cf">return</span></span>
<span id="cb17-14"><a href="#cb17-14"></a>        <span class="cf">if</span> doc.code_count[name] <span class="op">==</span> <span class="dv">0</span>:</span>
<span id="cb17-15"><a href="#cb17-15"></a>            label <span class="op">=</span> Span(Emph(Str(<span class="ss">f&quot;«</span><span class="sc">{</span>name<span class="sc">}</span><span class="ss">»=&quot;</span>)))</span>
<span id="cb17-16"><a href="#cb17-16"></a>            doc.code_count[name] <span class="op">+=</span> <span class="dv">1</span></span>
<span id="cb17-17"><a href="#cb17-17"></a>        <span class="cf">else</span>:</span>
<span id="cb17-18"><a href="#cb17-18"></a>            label <span class="op">=</span> Span(Emph(Str(<span class="ss">f&quot;«</span><span class="sc">{</span>name<span class="sc">}</span><span class="ss">»+&quot;</span>)))</span>
<span id="cb17-19"><a href="#cb17-19"></a>        <span class="cf">return</span> Div(Para(label), elem, classes<span class="op">=</span>[<span class="st">&quot;annotated-code&quot;</span>])</span>
<span id="cb17-20"><a href="#cb17-20"></a></span>
<span id="cb17-21"><a href="#cb17-21"></a><span class="kw">def</span> main(doc: Optional[Doc] <span class="op">=</span> <span class="va">None</span>) <span class="op">-&gt;</span> <span class="va">None</span>:</span>
<span id="cb17-22"><a href="#cb17-22"></a>    <span class="cf">return</span> run_filter(action, prepare<span class="op">=</span>prepare)</span></code></pre></div>
</div>
<h1 id="doctesting">Doctesting</h1>
<p>This Pandoc filter runs doc-tests from Python. If a cell is marked with a <code>.doctest</code> class, the output is checked against the given output. We use Jupyter kernels to evaluate the input.</p>
<div class="annotated-code">
<p><span><em>«entangled/doctest.py»=</em></span></p>
<div class="sourceCode" id="cb18" data-file="entangled/doctest.py"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb18-1"><a href="#cb18-1"></a><span class="im">from</span> panflute <span class="im">import</span> (Doc, Element, CodeBlock)</span>
<span id="cb18-2"><a href="#cb18-2"></a><span class="im">from</span> .typing <span class="im">import</span> (ActionReturn, JSONType, CodeMap)</span>
<span id="cb18-3"><a href="#cb18-3"></a><span class="im">from</span> .tangle <span class="im">import</span> (get_name, expand_code_block)</span>
<span id="cb18-4"><a href="#cb18-4"></a><span class="im">from</span> .config <span class="im">import</span> get_language_info</span>
<span id="cb18-5"><a href="#cb18-5"></a><span class="im">from</span> collections <span class="im">import</span> defaultdict</span>
<span id="cb18-6"><a href="#cb18-6"></a></span>
<span id="cb18-7"><a href="#cb18-7"></a><span class="im">import</span> sys</span>
<span id="cb18-8"><a href="#cb18-8"></a></span>
<span id="cb18-9"><a href="#cb18-9"></a><span class="op">&lt;&lt;</span>doctest<span class="op">-</span>suite<span class="op">&gt;&gt;</span></span>
<span id="cb18-10"><a href="#cb18-10"></a><span class="op">&lt;&lt;</span>get<span class="op">-</span>doc<span class="op">-</span>tests<span class="op">&gt;&gt;</span></span>
<span id="cb18-11"><a href="#cb18-11"></a><span class="op">&lt;&lt;</span>doctest<span class="op">-</span>report<span class="op">&gt;&gt;</span></span>
<span id="cb18-12"><a href="#cb18-12"></a><span class="op">&lt;&lt;</span>doctest<span class="op">-</span>run<span class="op">-</span>suite<span class="op">&gt;&gt;</span></span>
<span id="cb18-13"><a href="#cb18-13"></a></span>
<span id="cb18-14"><a href="#cb18-14"></a><span class="kw">def</span> prepare(doc: Doc) <span class="op">-&gt;</span> <span class="va">None</span>:</span>
<span id="cb18-15"><a href="#cb18-15"></a>    <span class="cf">assert</span> <span class="bu">hasattr</span>(doc, <span class="st">&quot;config&quot;</span>), <span class="st">&quot;Need to read config first.&quot;</span></span>
<span id="cb18-16"><a href="#cb18-16"></a>    <span class="cf">assert</span> <span class="bu">hasattr</span>(doc, <span class="st">&quot;code_map&quot;</span>), <span class="st">&quot;Need to tangle first.&quot;</span></span>
<span id="cb18-17"><a href="#cb18-17"></a>    doc.suites <span class="op">=</span> get_doc_tests(doc.code_map)</span>
<span id="cb18-18"><a href="#cb18-18"></a>    <span class="cf">for</span> name, suite <span class="kw">in</span> doc.suites.items():</span>
<span id="cb18-19"><a href="#cb18-19"></a>        run_suite(doc.config, suite)</span>
<span id="cb18-20"><a href="#cb18-20"></a>    doc.code_counter <span class="op">=</span> defaultdict(<span class="kw">lambda</span>: <span class="dv">0</span>)</span>
<span id="cb18-21"><a href="#cb18-21"></a></span>
<span id="cb18-22"><a href="#cb18-22"></a><span class="kw">def</span> action(elem: Element, doc: Doc) <span class="op">-&gt;</span> ActionReturn:</span>
<span id="cb18-23"><a href="#cb18-23"></a>    <span class="cf">if</span> <span class="bu">isinstance</span>(elem, CodeBlock):</span>
<span id="cb18-24"><a href="#cb18-24"></a>        name <span class="op">=</span> get_name(elem)</span>
<span id="cb18-25"><a href="#cb18-25"></a>        <span class="cf">if</span> <span class="st">&quot;doctest&quot;</span> <span class="kw">in</span> elem.classes <span class="kw">or</span> <span class="st">&quot;eval&quot;</span> <span class="kw">in</span> elem.classes:</span>
<span id="cb18-26"><a href="#cb18-26"></a>            test <span class="op">=</span> doc.suites[name].code_blocks[doc.code_counter[name]]</span>
<span id="cb18-27"><a href="#cb18-27"></a>            doc.code_counter[name] <span class="op">+=</span> <span class="dv">1</span></span>
<span id="cb18-28"><a href="#cb18-28"></a>            <span class="cf">return</span> generate_report(elem, test)</span>
<span id="cb18-29"><a href="#cb18-29"></a></span>
<span id="cb18-30"><a href="#cb18-30"></a>        doc.code_counter[name] <span class="op">+=</span> <span class="dv">1</span></span>
<span id="cb18-31"><a href="#cb18-31"></a>    <span class="cf">return</span> <span class="va">None</span></span></code></pre></div>
</div>
<h2 id="get-doc-tests-from-code-map">Get doc tests from code map</h2>
<div class="annotated-code">
<p><span><em>«get-doc-tests»=</em></span></p>
<div class="sourceCode" id="get-doc-tests"><pre class="sourceCode python"><code class="sourceCode python"><span id="get-doc-tests-1"><a href="#get-doc-tests-1"></a><span class="kw">def</span> get_language(c: CodeBlock) <span class="op">-&gt;</span> <span class="bu">str</span>:</span>
<span id="get-doc-tests-2"><a href="#get-doc-tests-2"></a>    <span class="cf">if</span> <span class="kw">not</span> c.classes:</span>
<span id="get-doc-tests-3"><a href="#get-doc-tests-3"></a>        <span class="cf">raise</span> <span class="pp">ValueError</span>(<span class="ss">f&quot;Code block `</span><span class="sc">{c.</span>name<span class="sc">}</span><span class="ss">` has no language specified.&quot;</span>)</span>
<span id="get-doc-tests-4"><a href="#get-doc-tests-4"></a>    <span class="cf">return</span> c.classes[<span class="dv">0</span>]</span>
<span id="get-doc-tests-5"><a href="#get-doc-tests-5"></a></span>
<span id="get-doc-tests-6"><a href="#get-doc-tests-6"></a><span class="kw">def</span> get_doc_tests(code_map: CodeMap) <span class="op">-&gt;</span> Dict[<span class="bu">str</span>, Suite]:</span>
<span id="get-doc-tests-7"><a href="#get-doc-tests-7"></a>    <span class="kw">def</span> convert_code_block(c: CodeBlock) <span class="op">-&gt;</span> Test:</span>
<span id="get-doc-tests-8"><a href="#get-doc-tests-8"></a>        name <span class="op">=</span> get_name(c)</span>
<span id="get-doc-tests-9"><a href="#get-doc-tests-9"></a>        code <span class="op">=</span> expand_code_block(code_map, c)</span>
<span id="get-doc-tests-10"><a href="#get-doc-tests-10"></a>        <span class="cf">if</span> <span class="st">&quot;doctest&quot;</span> <span class="kw">in</span> c.classes:</span>
<span id="get-doc-tests-11"><a href="#get-doc-tests-11"></a>            s <span class="op">=</span> code.split(<span class="st">&quot;</span><span class="ch">\n</span><span class="st">---</span><span class="ch">\n</span><span class="st">&quot;</span>)</span>
<span id="get-doc-tests-12"><a href="#get-doc-tests-12"></a>            <span class="cf">if</span> <span class="bu">len</span>(s) <span class="op">!=</span> <span class="dv">2</span>:</span>
<span id="get-doc-tests-13"><a href="#get-doc-tests-13"></a>                <span class="cf">raise</span> <span class="pp">ValueError</span>(<span class="ss">f&quot;Doc test `</span><span class="sc">{</span>name<span class="sc">}</span><span class="ss">` should have single `---` line.&quot;</span>)</span>
<span id="get-doc-tests-14"><a href="#get-doc-tests-14"></a>            <span class="cf">return</span> Test(s[<span class="dv">0</span>], s[<span class="dv">1</span>])</span>
<span id="get-doc-tests-15"><a href="#get-doc-tests-15"></a>        <span class="cf">else</span>:</span>
<span id="get-doc-tests-16"><a href="#get-doc-tests-16"></a>            <span class="cf">return</span> Test(code, <span class="va">None</span>)</span>
<span id="get-doc-tests-17"><a href="#get-doc-tests-17"></a></span>
<span id="get-doc-tests-18"><a href="#get-doc-tests-18"></a>    result <span class="op">=</span> {}</span>
<span id="get-doc-tests-19"><a href="#get-doc-tests-19"></a>    <span class="cf">for</span> k, v <span class="kw">in</span> code_map.items():</span>
<span id="get-doc-tests-20"><a href="#get-doc-tests-20"></a>        <span class="cf">if</span> <span class="bu">any</span>(<span class="st">&quot;doctest&quot;</span> <span class="kw">in</span> c.classes <span class="kw">or</span> <span class="st">&quot;eval&quot;</span> <span class="kw">in</span> c.classes <span class="cf">for</span> c <span class="kw">in</span> v):</span>
<span id="get-doc-tests-21"><a href="#get-doc-tests-21"></a>            result[k] <span class="op">=</span> Suite(</span>
<span id="get-doc-tests-22"><a href="#get-doc-tests-22"></a>                code_blocks<span class="op">=</span>[convert_code_block(c) <span class="cf">for</span> c <span class="kw">in</span> v],</span>
<span id="get-doc-tests-23"><a href="#get-doc-tests-23"></a>                language<span class="op">=</span>get_language(v[<span class="dv">0</span>]))</span>
<span id="get-doc-tests-24"><a href="#get-doc-tests-24"></a></span>
<span id="get-doc-tests-25"><a href="#get-doc-tests-25"></a>    <span class="cf">return</span> result</span></code></pre></div>
</div>
<h2 id="test-suite">Test Suite</h2>
<p>Every code block that is part of a <code>.doctest</code> suite will be stored in a <code>Test</code> object, even if it is not a doc-test block itself. The default <code>status</code> of a test is <code>PENDING</code>.</p>
<p>A test may succeed, fail, throw an error or return an unknown result (other than <code>text/plain</code>).</p>
<div class="annotated-code">
<p><span><em>«doctest-suite»=</em></span></p>
<div class="sourceCode" id="doctest-suite"><pre class="sourceCode python"><code class="sourceCode python"><span id="doctest-suite-1"><a href="#doctest-suite-1"></a><span class="im">from</span> dataclasses <span class="im">import</span> dataclass</span>
<span id="doctest-suite-2"><a href="#doctest-suite-2"></a><span class="im">from</span> typing <span class="im">import</span> (Optional, List, Dict)</span>
<span id="doctest-suite-3"><a href="#doctest-suite-3"></a><span class="im">from</span> enum <span class="im">import</span> Enum</span>
<span id="doctest-suite-4"><a href="#doctest-suite-4"></a></span>
<span id="doctest-suite-5"><a href="#doctest-suite-5"></a><span class="kw">class</span> TestStatus(Enum):</span>
<span id="doctest-suite-6"><a href="#doctest-suite-6"></a>    PENDING <span class="op">=</span> <span class="dv">0</span></span>
<span id="doctest-suite-7"><a href="#doctest-suite-7"></a>    SUCCESS <span class="op">=</span> <span class="dv">1</span></span>
<span id="doctest-suite-8"><a href="#doctest-suite-8"></a>    FAIL <span class="op">=</span> <span class="dv">2</span></span>
<span id="doctest-suite-9"><a href="#doctest-suite-9"></a>    ERROR <span class="op">=</span> <span class="dv">3</span></span>
<span id="doctest-suite-10"><a href="#doctest-suite-10"></a>    UNKNOWN <span class="op">=</span> <span class="dv">4</span></span></code></pre></div>
</div>
<div class="annotated-code">
<p><span><em>«doctest-suite»+</em></span></p>
<div class="sourceCode" id="doctest-suite"><pre class="sourceCode python"><code class="sourceCode python"><span id="doctest-suite-1"><a href="#doctest-suite-1"></a><span class="at">@dataclass</span></span>
<span id="doctest-suite-2"><a href="#doctest-suite-2"></a><span class="kw">class</span> Test:</span>
<span id="doctest-suite-3"><a href="#doctest-suite-3"></a>    __test__ <span class="op">=</span> <span class="va">False</span>    <span class="co"># not a pytest class</span></span>
<span id="doctest-suite-4"><a href="#doctest-suite-4"></a>    code: <span class="bu">str</span></span>
<span id="doctest-suite-5"><a href="#doctest-suite-5"></a>    expect: Optional[<span class="bu">str</span>]</span>
<span id="doctest-suite-6"><a href="#doctest-suite-6"></a>    result: Optional[<span class="bu">str</span>] <span class="op">=</span> <span class="va">None</span></span>
<span id="doctest-suite-7"><a href="#doctest-suite-7"></a>    error: Optional[<span class="bu">str</span>] <span class="op">=</span> <span class="va">None</span></span>
<span id="doctest-suite-8"><a href="#doctest-suite-8"></a>    status: TestStatus <span class="op">=</span> TestStatus.PENDING</span></code></pre></div>
</div>
<p>A suite is just a list of <code>Test</code>s with some meta-data attached.</p>
<div class="annotated-code">
<p><span><em>«doctest-suite»+</em></span></p>
<div class="sourceCode" id="doctest-suite"><pre class="sourceCode python"><code class="sourceCode python"><span id="doctest-suite-1"><a href="#doctest-suite-1"></a><span class="at">@dataclass</span></span>
<span id="doctest-suite-2"><a href="#doctest-suite-2"></a><span class="kw">class</span> Suite:</span>
<span id="doctest-suite-3"><a href="#doctest-suite-3"></a>    code_blocks: List[Test]</span>
<span id="doctest-suite-4"><a href="#doctest-suite-4"></a>    language: <span class="bu">str</span></span></code></pre></div>
</div>
<h2 id="evaluation">Evaluation</h2>
<p>We use <code>jupyter_client</code> to communicate with the REPL in question.</p>
<div class="annotated-code">
<p><span><em>«doctest-run-suite»=</em></span></p>
<div class="sourceCode" id="doctest-run-suite"><pre class="sourceCode python"><code class="sourceCode python"><span id="doctest-run-suite-1"><a href="#doctest-run-suite-1"></a><span class="im">import</span> jupyter_client</span>
<span id="doctest-run-suite-2"><a href="#doctest-run-suite-2"></a><span class="im">import</span> queue</span>
<span id="doctest-run-suite-3"><a href="#doctest-run-suite-3"></a></span>
<span id="doctest-run-suite-4"><a href="#doctest-run-suite-4"></a><span class="kw">def</span> run_suite(config: JSONType, s: Suite) <span class="op">-&gt;</span> <span class="va">None</span>:</span>
<span id="doctest-run-suite-5"><a href="#doctest-run-suite-5"></a>    <span class="op">&lt;&lt;</span>jupyter<span class="op">-</span>get<span class="op">-</span>kernel<span class="op">-</span>name<span class="op">&gt;&gt;</span></span>
<span id="doctest-run-suite-6"><a href="#doctest-run-suite-6"></a>    <span class="cf">with</span> jupyter_client.run_kernel(kernel_name<span class="op">=</span>kernel_name) <span class="im">as</span> kc:</span>
<span id="doctest-run-suite-7"><a href="#doctest-run-suite-7"></a>        <span class="bu">print</span>(<span class="ss">f&quot;Kernel `</span><span class="sc">{</span>kernel_name<span class="sc">}</span><span class="ss">` running ...&quot;</span>, <span class="bu">file</span><span class="op">=</span>sys.stderr)</span>
<span id="doctest-run-suite-8"><a href="#doctest-run-suite-8"></a>        <span class="op">&lt;&lt;</span>jupyter<span class="op">-</span><span class="bu">eval</span><span class="op">-</span>test<span class="op">&gt;&gt;</span></span>
<span id="doctest-run-suite-9"><a href="#doctest-run-suite-9"></a></span>
<span id="doctest-run-suite-10"><a href="#doctest-run-suite-10"></a>        <span class="cf">for</span> test <span class="kw">in</span> s.code_blocks:</span>
<span id="doctest-run-suite-11"><a href="#doctest-run-suite-11"></a>            jupyter_eval(test)</span>
<span id="doctest-run-suite-12"><a href="#doctest-run-suite-12"></a>            <span class="cf">if</span> test.status <span class="kw">is</span> TestStatus.ERROR:</span>
<span id="doctest-run-suite-13"><a href="#doctest-run-suite-13"></a>                <span class="cf">break</span></span></code></pre></div>
</div>
<h3 id="jupyter">Jupyter</h3>
<p>The configuration should have a Jupyter kernel name stored for the language.</p>
<div class="annotated-code">
<p><span><em>«jupyter-get-kernel-name»=</em></span></p>
<div class="sourceCode" id="jupyter-get-kernel-name"><pre class="sourceCode python"><code class="sourceCode python"><span id="jupyter-get-kernel-name-1"><a href="#jupyter-get-kernel-name-1"></a>info <span class="op">=</span> get_language_info(config, s.language)</span>
<span id="jupyter-get-kernel-name-2"><a href="#jupyter-get-kernel-name-2"></a>kernel_name <span class="op">=</span> info[<span class="st">&quot;jupyter&quot;</span>] <span class="cf">if</span> <span class="st">&quot;jupyter&quot;</span> <span class="kw">in</span> info <span class="cf">else</span> <span class="va">None</span></span>
<span id="jupyter-get-kernel-name-3"><a href="#jupyter-get-kernel-name-3"></a><span class="cf">if</span> <span class="kw">not</span> kernel_name:</span>
<span id="jupyter-get-kernel-name-4"><a href="#jupyter-get-kernel-name-4"></a>    <span class="cf">raise</span> <span class="pp">RuntimeError</span>(<span class="ss">f&quot;No Jupyter kernel known for the </span><span class="sc">{s.</span>language<span class="sc">}</span><span class="ss"> language.&quot;</span>)</span>
<span id="jupyter-get-kernel-name-5"><a href="#jupyter-get-kernel-name-5"></a>specs <span class="op">=</span> jupyter_client.kernelspec.find_kernel_specs()</span>
<span id="jupyter-get-kernel-name-6"><a href="#jupyter-get-kernel-name-6"></a><span class="cf">if</span> kernel_name <span class="kw">not</span> <span class="kw">in</span> specs:</span>
<span id="jupyter-get-kernel-name-7"><a href="#jupyter-get-kernel-name-7"></a>    <span class="cf">raise</span> <span class="pp">RuntimeError</span>(<span class="ss">f&quot;Jupyter kernel `</span><span class="sc">{</span>kernel_name<span class="sc">}</span><span class="ss">` not installed.&quot;</span>)</span></code></pre></div>
</div>
<p>After sending the test to the Jupyter kernel, we need to retrieve the result. To match the JSON records, we use <code>pampy</code>, making the following code a lot cleaner.</p>
<div class="annotated-code">
<p><span><em>«jupyter-eval-test»=</em></span></p>
<div class="sourceCode" id="jupyter-eval-test"><pre class="sourceCode python"><code class="sourceCode python"><span id="jupyter-eval-test-1"><a href="#jupyter-eval-test-1"></a><span class="kw">def</span> jupyter_eval(test: Test):</span>
<span id="jupyter-eval-test-2"><a href="#jupyter-eval-test-2"></a>    msg_id <span class="op">=</span> kc.execute(test.code)</span>
<span id="jupyter-eval-test-3"><a href="#jupyter-eval-test-3"></a>    <span class="cf">while</span> <span class="va">True</span>:</span>
<span id="jupyter-eval-test-4"><a href="#jupyter-eval-test-4"></a>        <span class="cf">try</span>:</span>
<span id="jupyter-eval-test-5"><a href="#jupyter-eval-test-5"></a>            msg <span class="op">=</span> kc.get_iopub_msg(timeout<span class="op">=</span><span class="dv">1000</span>)</span>
<span id="jupyter-eval-test-6"><a href="#jupyter-eval-test-6"></a>            <span class="cf">if</span> handle(test, msg_id, msg):</span>
<span id="jupyter-eval-test-7"><a href="#jupyter-eval-test-7"></a>               <span class="cf">return</span></span>
<span id="jupyter-eval-test-8"><a href="#jupyter-eval-test-8"></a></span>
<span id="jupyter-eval-test-9"><a href="#jupyter-eval-test-9"></a>        <span class="cf">except</span> queue.Empty:</span>
<span id="jupyter-eval-test-10"><a href="#jupyter-eval-test-10"></a>            test.error <span class="op">=</span> <span class="st">&quot;Operation timed out.&quot;</span></span>
<span id="jupyter-eval-test-11"><a href="#jupyter-eval-test-11"></a>            test.status <span class="op">=</span> TestStatus.ERROR</span>
<span id="jupyter-eval-test-12"><a href="#jupyter-eval-test-12"></a>            <span class="cf">return</span></span></code></pre></div>
</div>
<p>The <code>handle</code> function is a pattern matcher. Each pattern looks like a dictionary, but may contain one or more <code>_</code> symbols. The contents of the matching dictionary at the <code>_</code> symbols are passed to the function following the pattern.</p>
<div class="annotated-code">
<p><span><em>«jupyter-eval-test»+</em></span></p>
<div class="sourceCode" id="jupyter-eval-test"><pre class="sourceCode python"><code class="sourceCode python"><span id="jupyter-eval-test-1"><a href="#jupyter-eval-test-1"></a><span class="kw">def</span> handle(test, msg_id, msg):</span>
<span id="jupyter-eval-test-2"><a href="#jupyter-eval-test-2"></a>    <span class="im">from</span> pampy <span class="im">import</span> match, _</span>
<span id="jupyter-eval-test-3"><a href="#jupyter-eval-test-3"></a>    <span class="op">&lt;&lt;</span>jupyter<span class="op">-</span>handlers<span class="op">&gt;&gt;</span></span>
<span id="jupyter-eval-test-4"><a href="#jupyter-eval-test-4"></a>    <span class="cf">return</span> match(msg</span>
<span id="jupyter-eval-test-5"><a href="#jupyter-eval-test-5"></a>        <span class="op">&lt;&lt;</span>jupyter<span class="op">-</span>match<span class="op">&gt;&gt;</span></span>
<span id="jupyter-eval-test-6"><a href="#jupyter-eval-test-6"></a>        )</span></code></pre></div>
</div>
<h4 id="execute_result"><code>execute_result</code></h4>
<p>A result is tested for equality with the expected result.</p>
<div class="annotated-code">
<p><span><em>«jupyter-match»=</em></span></p>
<div class="sourceCode" id="jupyter-match"><pre class="sourceCode python"><code class="sourceCode python"><span id="jupyter-match-1"><a href="#jupyter-match-1"></a>, { <span class="st">&quot;msg_type&quot;</span>: <span class="st">&quot;execute_result&quot;</span></span>
<span id="jupyter-match-2"><a href="#jupyter-match-2"></a>  , <span class="st">&quot;parent_header&quot;</span>: { <span class="st">&quot;msg_id&quot;</span> : msg_id }</span>
<span id="jupyter-match-3"><a href="#jupyter-match-3"></a>  , <span class="st">&quot;content&quot;</span>: { <span class="st">&quot;data&quot;</span> : { <span class="st">&quot;text/plain&quot;</span>: _ } } }</span>
<span id="jupyter-match-4"><a href="#jupyter-match-4"></a>, execute_result_text</span></code></pre></div>
</div>
<div class="annotated-code">
<p><span><em>«jupyter-handlers»=</em></span></p>
<div class="sourceCode" id="jupyter-handlers"><pre class="sourceCode python"><code class="sourceCode python"><span id="jupyter-handlers-1"><a href="#jupyter-handlers-1"></a><span class="kw">def</span> execute_result_text(data):</span>
<span id="jupyter-handlers-2"><a href="#jupyter-handlers-2"></a>    test.result <span class="op">=</span> data</span>
<span id="jupyter-handlers-3"><a href="#jupyter-handlers-3"></a>    <span class="cf">if</span> (test.expect <span class="kw">is</span> <span class="va">None</span>) <span class="kw">or</span> test.result.strip() <span class="op">==</span> test.expect.strip():</span>
<span id="jupyter-handlers-4"><a href="#jupyter-handlers-4"></a>        test.status <span class="op">=</span> TestStatus.SUCCESS</span>
<span id="jupyter-handlers-5"><a href="#jupyter-handlers-5"></a>    <span class="cf">else</span>:</span>
<span id="jupyter-handlers-6"><a href="#jupyter-handlers-6"></a>        test.status <span class="op">=</span> TestStatus.FAIL</span>
<span id="jupyter-handlers-7"><a href="#jupyter-handlers-7"></a>    <span class="cf">return</span> <span class="va">False</span></span></code></pre></div>
</div>
<h4 id="output-to-stdout-or-stderr">output to stdout or stderr</h4>
<div class="annotated-code">
<p><span><em>«jupyter-match»+</em></span></p>
<div class="sourceCode" id="jupyter-match"><pre class="sourceCode python"><code class="sourceCode python"><span id="jupyter-match-1"><a href="#jupyter-match-1"></a>, { <span class="st">&quot;msg_type&quot;</span>: <span class="st">&quot;stream&quot;</span></span>
<span id="jupyter-match-2"><a href="#jupyter-match-2"></a>  , <span class="st">&quot;parent_header&quot;</span>: { <span class="st">&quot;msg_id&quot;</span> : msg_id }</span>
<span id="jupyter-match-3"><a href="#jupyter-match-3"></a>  , <span class="st">&quot;content&quot;</span>: { <span class="st">&quot;text&quot;</span>: _ } }</span>
<span id="jupyter-match-4"><a href="#jupyter-match-4"></a>, stream_text</span></code></pre></div>
</div>
<div class="annotated-code">
<p><span><em>«jupyter-handlers»+</em></span></p>
<div class="sourceCode" id="jupyter-handlers"><pre class="sourceCode python"><code class="sourceCode python"><span id="jupyter-handlers-1"><a href="#jupyter-handlers-1"></a><span class="kw">def</span> stream_text(data):</span>
<span id="jupyter-handlers-2"><a href="#jupyter-handlers-2"></a>    test.result <span class="op">=</span> test.result <span class="kw">or</span> <span class="st">&quot;&quot;</span></span>
<span id="jupyter-handlers-3"><a href="#jupyter-handlers-3"></a>    test.result <span class="op">+=</span> data</span>
<span id="jupyter-handlers-4"><a href="#jupyter-handlers-4"></a>    <span class="cf">return</span> <span class="va">False</span></span></code></pre></div>
</div>
<h4 id="status"><code>status</code></h4>
<p>If status <code>idle</code> is given, the computation is done, and we don’t need to wait for further messages.</p>
<div class="annotated-code">
<p><span><em>«jupyter-match»+</em></span></p>
<div class="sourceCode" id="jupyter-match"><pre class="sourceCode python"><code class="sourceCode python"><span id="jupyter-match-1"><a href="#jupyter-match-1"></a>, { <span class="st">&quot;msg_type&quot;</span>: <span class="st">&quot;status&quot;</span></span>
<span id="jupyter-match-2"><a href="#jupyter-match-2"></a>  , <span class="st">&quot;parent_header&quot;</span>: { <span class="st">&quot;msg_id&quot;</span> : msg_id }</span>
<span id="jupyter-match-3"><a href="#jupyter-match-3"></a>  , <span class="st">&quot;content&quot;</span>: { <span class="st">&quot;execution_state&quot;</span>: <span class="st">&quot;idle&quot;</span> } }</span>
<span id="jupyter-match-4"><a href="#jupyter-match-4"></a>, status_idle</span></code></pre></div>
</div>
<div class="annotated-code">
<p><span><em>«jupyter-handlers»+</em></span></p>
<div class="sourceCode" id="jupyter-handlers"><pre class="sourceCode python"><code class="sourceCode python"><span id="jupyter-handlers-1"><a href="#jupyter-handlers-1"></a><span class="kw">def</span> status_idle(_):</span>
<span id="jupyter-handlers-2"><a href="#jupyter-handlers-2"></a>    <span class="cf">if</span> test.expect <span class="kw">is</span> <span class="va">None</span>:</span>
<span id="jupyter-handlers-3"><a href="#jupyter-handlers-3"></a>        test.status <span class="op">=</span> TestStatus.SUCCESS</span>
<span id="jupyter-handlers-4"><a href="#jupyter-handlers-4"></a>    <span class="cf">elif</span> test.status <span class="op">==</span> TestStatus.PENDING:</span>
<span id="jupyter-handlers-5"><a href="#jupyter-handlers-5"></a>        test.status <span class="op">=</span> TestStatus.FAIL</span>
<span id="jupyter-handlers-6"><a href="#jupyter-handlers-6"></a>    <span class="cf">return</span> <span class="va">True</span></span></code></pre></div>
</div>
<h4 id="error"><code>error</code></h4>
<p>If an error is given, we set the appropriate flags in <code>test</code> and stop further testing in this session.</p>
<div class="annotated-code">
<p><span><em>«jupyter-match»+</em></span></p>
<div class="sourceCode" id="jupyter-match"><pre class="sourceCode python"><code class="sourceCode python"><span id="jupyter-match-1"><a href="#jupyter-match-1"></a>, { <span class="st">&quot;msg_type&quot;</span>: <span class="st">&quot;error&quot;</span></span>
<span id="jupyter-match-2"><a href="#jupyter-match-2"></a>  , <span class="st">&quot;parent_header&quot;</span>: { <span class="st">&quot;msg_id&quot;</span> : msg_id }</span>
<span id="jupyter-match-3"><a href="#jupyter-match-3"></a>  , <span class="st">&quot;content&quot;</span>: { <span class="st">&quot;traceback&quot;</span>: _ } }</span>
<span id="jupyter-match-4"><a href="#jupyter-match-4"></a>, error_traceback</span></code></pre></div>
</div>
<div class="annotated-code">
<p><span><em>«jupyter-handlers»+</em></span></p>
<div class="sourceCode" id="jupyter-handlers"><pre class="sourceCode python"><code class="sourceCode python"><span id="jupyter-handlers-1"><a href="#jupyter-handlers-1"></a><span class="kw">def</span> error_traceback(tb):</span>
<span id="jupyter-handlers-2"><a href="#jupyter-handlers-2"></a>    test.error <span class="op">=</span> <span class="st">&quot;</span><span class="ch">\n</span><span class="st">&quot;</span>.join(msg[<span class="st">&quot;content&quot;</span>][<span class="st">&quot;traceback&quot;</span>])</span>
<span id="jupyter-handlers-3"><a href="#jupyter-handlers-3"></a>    test.status <span class="op">=</span> TestStatus.ERROR </span>
<span id="jupyter-handlers-4"><a href="#jupyter-handlers-4"></a>    <span class="cf">return</span> <span class="va">True</span></span></code></pre></div>
</div>
<h4 id="otherwise">otherwise</h4>
<p>Any other message we ignore and wait for further messages.</p>
<div class="annotated-code">
<p><span><em>«jupyter-match»+</em></span></p>
<div class="sourceCode" id="jupyter-match"><pre class="sourceCode python"><code class="sourceCode python"><span id="jupyter-match-1"><a href="#jupyter-match-1"></a>, _</span>
<span id="jupyter-match-2"><a href="#jupyter-match-2"></a>, <span class="kw">lambda</span> x: <span class="va">False</span></span></code></pre></div>
</div>
<h2 id="generate-report">Generate report</h2>
<p>The generic output of a documentation test, in HTML, should look something like:</p>
<div class="sourceCode" id="cb19"><pre class="sourceCode html"><code class="sourceCode html"><span id="cb19-1"><a href="#cb19-1"></a><span class="kw">&lt;div</span><span class="ot"> class=</span><span class="st">&quot;doctest&quot;</span><span class="ot"> data-status=</span><span class="st">&quot;STATUS&quot;</span><span class="kw">&gt;</span></span>
<span id="cb19-2"><a href="#cb19-2"></a>    <span class="kw">&lt;div</span><span class="ot"> class=</span><span class="st">&quot;doctestInput&quot;</span><span class="kw">&gt;</span><span class="er">&lt;</span>...&gt;<span class="kw">&lt;/div&gt;</span></span>
<span id="cb19-3"><a href="#cb19-3"></a>    <span class="kw">&lt;div</span><span class="ot"> class=</span><span class="st">&quot;doctestResult&quot;</span><span class="kw">&gt;</span><span class="er">&lt;</span>...&gt;<span class="kw">&lt;/div&gt;</span></span>
<span id="cb19-4"><a href="#cb19-4"></a><span class="kw">&lt;/div&gt;</span></span></code></pre></div>
<p>To create the outer <code>div</code> we have a helper function.</p>
<div class="annotated-code">
<p><span><em>«doctest-content-div»=</em></span></p>
<div class="sourceCode" id="doctest-content-div"><pre class="sourceCode python"><code class="sourceCode python"><span id="doctest-content-div-1"><a href="#doctest-content-div-1"></a><span class="kw">def</span> content_div(<span class="op">*</span>output):</span>
<span id="doctest-content-div-2"><a href="#doctest-content-div-2"></a>    status_attr <span class="op">=</span> {<span class="st">&quot;status&quot;</span>: t.status.name}</span>
<span id="doctest-content-div-3"><a href="#doctest-content-div-3"></a>    code <span class="op">=</span> elem.text.split(<span class="st">&quot;</span><span class="ch">\n</span><span class="st">---</span><span class="ch">\n</span><span class="st">&quot;</span>)</span>
<span id="doctest-content-div-4"><a href="#doctest-content-div-4"></a>    input_code <span class="op">=</span> Div(CodeBlock(</span>
<span id="doctest-content-div-5"><a href="#doctest-content-div-5"></a>        code[<span class="dv">0</span>], identifier<span class="op">=</span>elem.identifier,</span>
<span id="doctest-content-div-6"><a href="#doctest-content-div-6"></a>        classes<span class="op">=</span>elem.classes), classes<span class="op">=</span>[<span class="st">&quot;doctestInput&quot;</span>])</span>
<span id="doctest-content-div-7"><a href="#doctest-content-div-7"></a>    <span class="cf">return</span> Div(input_code, <span class="op">*</span>output, classes<span class="op">=</span>[<span class="st">&quot;doctest&quot;</span>], attributes<span class="op">=</span>status_attr)</span></code></pre></div>
</div>
<p>Then the <code>generate_report</code> function transforms a <code>CodeBlock</code> as follows.</p>
<div class="annotated-code">
<p><span><em>«doctest-report»=</em></span></p>
<div class="sourceCode" id="doctest-report"><pre class="sourceCode python"><code class="sourceCode python"><span id="doctest-report-1"><a href="#doctest-report-1"></a><span class="im">from</span> panflute <span class="im">import</span> Div</span>
<span id="doctest-report-2"><a href="#doctest-report-2"></a></span>
<span id="doctest-report-3"><a href="#doctest-report-3"></a><span class="kw">def</span> generate_report(elem: CodeBlock, t: Test) <span class="op">-&gt;</span> ActionReturn:</span>
<span id="doctest-report-4"><a href="#doctest-report-4"></a>    lang_class <span class="op">=</span> elem.classes[<span class="dv">0</span>]</span>
<span id="doctest-report-5"><a href="#doctest-report-5"></a></span>
<span id="doctest-report-6"><a href="#doctest-report-6"></a>    <span class="op">&lt;&lt;</span>doctest<span class="op">-</span>content<span class="op">-</span>div<span class="op">&gt;&gt;</span></span>
<span id="doctest-report-7"><a href="#doctest-report-7"></a>    <span class="cf">if</span> t.status <span class="kw">is</span> TestStatus.ERROR:</span>
<span id="doctest-report-8"><a href="#doctest-report-8"></a>        <span class="cf">return</span> content_div( Div( CodeBlock(<span class="bu">str</span>(t.error))</span>
<span id="doctest-report-9"><a href="#doctest-report-9"></a>                               , classes<span class="op">=</span>[<span class="st">&quot;doctestError&quot;</span>] ) )</span>
<span id="doctest-report-10"><a href="#doctest-report-10"></a>    <span class="cf">if</span> t.status <span class="kw">is</span> TestStatus.FAIL:</span>
<span id="doctest-report-11"><a href="#doctest-report-11"></a>        <span class="cf">return</span> content_div( Div( CodeBlock(<span class="bu">str</span>(t.result), classes<span class="op">=</span>[lang_class])</span>
<span id="doctest-report-12"><a href="#doctest-report-12"></a>                               , classes<span class="op">=</span>[<span class="st">&quot;doctestResult&quot;</span>] )</span>
<span id="doctest-report-13"><a href="#doctest-report-13"></a>                          , Div( CodeBlock(<span class="bu">str</span>(t.expect), classes<span class="op">=</span>[lang_class])</span>
<span id="doctest-report-14"><a href="#doctest-report-14"></a>                               , classes<span class="op">=</span>[<span class="st">&quot;doctestExpect&quot;</span>] ) )</span>
<span id="doctest-report-15"><a href="#doctest-report-15"></a>    <span class="cf">if</span> t.status <span class="kw">is</span> TestStatus.SUCCESS:</span>
<span id="doctest-report-16"><a href="#doctest-report-16"></a>        <span class="cf">return</span> content_div( Div( CodeBlock(<span class="bu">str</span>(t.result), classes<span class="op">=</span>[lang_class])</span>
<span id="doctest-report-17"><a href="#doctest-report-17"></a>                               , classes<span class="op">=</span>[<span class="st">&quot;doctestResult&quot;</span>] ) )</span>
<span id="doctest-report-18"><a href="#doctest-report-18"></a>    <span class="cf">if</span> t.status <span class="kw">is</span> TestStatus.PENDING:</span>
<span id="doctest-report-19"><a href="#doctest-report-19"></a>        <span class="cf">return</span> content_div()</span>
<span id="doctest-report-20"><a href="#doctest-report-20"></a>    <span class="cf">if</span> t.status <span class="kw">is</span> TestStatus.UNKNOWN:</span>
<span id="doctest-report-21"><a href="#doctest-report-21"></a>        <span class="cf">return</span> content_div( Div( CodeBlock(<span class="bu">str</span>(t.result))</span>
<span id="doctest-report-22"><a href="#doctest-report-22"></a>                               , classes<span class="op">=</span>[<span class="st">&quot;doctestUnknown&quot;</span>] ) )</span>
<span id="doctest-report-23"><a href="#doctest-report-23"></a>    <span class="cf">return</span> <span class="va">None</span></span></code></pre></div>
</div>
<h2 id="main">Main</h2>
<p>This module reuses most of the tangle module.</p>
<div class="annotated-code">
<p><span><em>«entangled/doctest_main.py»=</em></span></p>
<div class="sourceCode" id="cb20" data-file="entangled/doctest_main.py"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb20-1"><a href="#cb20-1"></a><span class="im">import</span> panflute</span>
<span id="cb20-2"><a href="#cb20-2"></a></span>
<span id="cb20-3"><a href="#cb20-3"></a><span class="im">from</span> . <span class="im">import</span> tangle</span>
<span id="cb20-4"><a href="#cb20-4"></a><span class="im">from</span> . <span class="im">import</span> annotate</span>
<span id="cb20-5"><a href="#cb20-5"></a><span class="im">from</span> . <span class="im">import</span> doctest</span>
<span id="cb20-6"><a href="#cb20-6"></a></span>
<span id="cb20-7"><a href="#cb20-7"></a><span class="im">from</span> .config <span class="im">import</span> read_config</span>
<span id="cb20-8"><a href="#cb20-8"></a></span>
<span id="cb20-9"><a href="#cb20-9"></a></span>
<span id="cb20-10"><a href="#cb20-10"></a><span class="kw">def</span> main() <span class="op">-&gt;</span> <span class="va">None</span>:</span>
<span id="cb20-11"><a href="#cb20-11"></a>    <span class="op">&lt;&lt;</span>load<span class="op">-</span>document<span class="op">&gt;&gt;</span></span>
<span id="cb20-12"><a href="#cb20-12"></a>    doc.config <span class="op">=</span> read_config()</span>
<span id="cb20-13"><a href="#cb20-13"></a></span>
<span id="cb20-14"><a href="#cb20-14"></a>    tangle.prepare(doc)</span>
<span id="cb20-15"><a href="#cb20-15"></a>    doc <span class="op">=</span> doc.walk(tangle.action)</span>
<span id="cb20-16"><a href="#cb20-16"></a></span>
<span id="cb20-17"><a href="#cb20-17"></a>    annotate.prepare(doc)</span>
<span id="cb20-18"><a href="#cb20-18"></a>    <span class="co"># doc = doc.walk(annotate.action)</span></span>
<span id="cb20-19"><a href="#cb20-19"></a></span>
<span id="cb20-20"><a href="#cb20-20"></a>    doctest.prepare(doc)</span>
<span id="cb20-21"><a href="#cb20-21"></a>    doc <span class="op">=</span> doc.walk(doctest.action)</span>
<span id="cb20-22"><a href="#cb20-22"></a></span>
<span id="cb20-23"><a href="#cb20-23"></a>    panflute.dump(doc)</span></code></pre></div>
</div>
<h2 id="bug-in-panflute-or-jupyter_client">Bug in <code>panflute</code> or <code>jupyter_client</code></h2>
<p>There is a bug in <code>jupyter_client</code> that prevents it from working when either <code>stdin</code> or <code>stdout</code> is closed. This means that we have to read the input seperately.</p>
<div class="annotated-code">
<p><span><em>«load-document»=</em></span></p>
<div class="sourceCode" id="load-document"><pre class="sourceCode python"><code class="sourceCode python"><span id="load-document-1"><a href="#load-document-1"></a><span class="im">import</span> io</span>
<span id="load-document-2"><a href="#load-document-2"></a><span class="im">import</span> sys</span>
<span id="load-document-3"><a href="#load-document-3"></a></span>
<span id="load-document-4"><a href="#load-document-4"></a>json_input <span class="op">=</span> sys.stdin.read()</span>
<span id="load-document-5"><a href="#load-document-5"></a>json_stream <span class="op">=</span> io.StringIO(json_input)</span>
<span id="load-document-6"><a href="#load-document-6"></a>doc <span class="op">=</span> panflute.load(json_stream)</span></code></pre></div>
</div>
<h1 id="bootstrap">Bootstrap</h1>
<p>The <code>pandoc-bootstrap</code> filter enables content generation for Bootstrap 4. This has the following features:</p>
<ul>
<li>Generate a <em>card deck</em> from a Yaml description in a code block.</li>
<li>Create collapsible code cells to hide boilerplate or othewise boring code.</li>
</ul>
<h2 id="card-deck">Card deck</h2>
<div class="annotated-code">
<p><span><em>«entangled/schema/Card.dhall»=</em></span></p>
<div class="sourceCode" id="cb21" data-file="entangled/schema/Card.dhall"><pre class="sourceCode dhall"><code class="sourceCode dhall"><span id="cb21-1"><a href="#cb21-1"></a><span class="kw">let</span> <span class="dt">Link</span> <span class="fu">=</span></span>
<span id="cb21-2"><a href="#cb21-2"></a>    { href <span class="fu">:</span> <span class="dt">Text</span></span>
<span id="cb21-3"><a href="#cb21-3"></a>    , content <span class="fu">:</span> <span class="dt">Text</span></span>
<span id="cb21-4"><a href="#cb21-4"></a>    }</span>
<span id="cb21-5"><a href="#cb21-5"></a></span>
<span id="cb21-6"><a href="#cb21-6"></a><span class="kw">in</span> <span class="kw">let</span> <span class="dt">Card</span> <span class="fu">=</span></span>
<span id="cb21-7"><a href="#cb21-7"></a>    { <span class="dt">Type</span> <span class="fu">=</span></span>
<span id="cb21-8"><a href="#cb21-8"></a>        { image <span class="fu">:</span> <span class="dt">Optional</span> <span class="dt">Text</span></span>
<span id="cb21-9"><a href="#cb21-9"></a>        , title <span class="fu">:</span> <span class="dt">Text</span></span>
<span id="cb21-10"><a href="#cb21-10"></a>        , text <span class="fu">:</span> <span class="dt">Text</span></span>
<span id="cb21-11"><a href="#cb21-11"></a>        , link <span class="fu">:</span> <span class="dt">Optional</span> <span class="dt">Link</span> }</span>
<span id="cb21-12"><a href="#cb21-12"></a>    , default <span class="fu">=</span></span>
<span id="cb21-13"><a href="#cb21-13"></a>        { image <span class="fu">=</span> <span class="dt">None</span> <span class="dt">Text</span></span>
<span id="cb21-14"><a href="#cb21-14"></a>        , link <span class="fu">=</span> <span class="dt">None</span> <span class="dt">Link</span> }</span>
<span id="cb21-15"><a href="#cb21-15"></a>    }</span>
<span id="cb21-16"><a href="#cb21-16"></a></span>
<span id="cb21-17"><a href="#cb21-17"></a><span class="kw">in</span> <span class="dt">Card</span></span></code></pre></div>
</div>
<div class="annotated-code">
<p><span><em>«test/card-deck-example.dhall»=</em></span></p>
<div class="sourceCode" id="cb22" data-file="test/card-deck-example.dhall"><pre class="sourceCode dhall"><code class="sourceCode dhall"><span id="cb22-1"><a href="#cb22-1"></a><span class="kw">let</span> <span class="dt">Card</span> <span class="fu">=</span> <span class="fu">./</span>schema<span class="fu">/</span>Card.dhall</span>
<span id="cb22-2"><a href="#cb22-2"></a></span>
<span id="cb22-3"><a href="#cb22-3"></a><span class="kw">in</span> [ <span class="dt">Card</span><span class="ot"> ::</span> { title <span class="fu">=</span> <span class="st">&quot;Literate Programming&quot;</span></span>
<span id="cb22-4"><a href="#cb22-4"></a>             , text <span class="fu">=</span></span>
<span id="cb22-5"><a href="#cb22-5"></a>                 <span class="st">&#39;&#39;</span></span>
<span id="cb22-6"><a href="#cb22-6"></a><span class="st">                 Write prose and code intermixed. Not just some choice snippets: **all code is included!**</span></span>
<span id="cb22-7"><a href="#cb22-7"></a><span class="st">                 This document is a rendering of a completely **self-contained Markdown** file.</span></span>
<span id="cb22-8"><a href="#cb22-8"></a><span class="st">                 &#39;&#39;</span></span>
<span id="cb22-9"><a href="#cb22-9"></a>             , link <span class="fu">=</span> <span class="dt">Some</span> { href <span class="fu">=</span> <span class="st">&quot;http://entangled.github.io/&quot;</span></span>
<span id="cb22-10"><a href="#cb22-10"></a>                           , content <span class="fu">=</span> <span class="st">&quot;About Entangled&quot;</span> } } ]</span></code></pre></div>
</div>
<p>Should generate something like:</p>
<div class="sourceCode" id="cb23"><pre class="sourceCode html"><code class="sourceCode html"><span id="cb23-1"><a href="#cb23-1"></a><span class="kw">&lt;div</span><span class="ot"> class=</span><span class="st">&quot;container-fluid&quot;</span><span class="kw">&gt;&lt;div</span><span class="ot"> class=</span><span class="st">&quot;row&quot;</span><span class="kw">&gt;</span></span>
<span id="cb23-2"><a href="#cb23-2"></a>    <span class="kw">&lt;div</span><span class="ot"> class=</span><span class="st">&quot;col&quot;</span><span class="kw">&gt;&lt;div</span><span class="ot"> class=</span><span class="st">&quot;card h-100&quot;</span><span class="kw">&gt;</span></span>
<span id="cb23-3"><a href="#cb23-3"></a>    <span class="kw">&lt;div</span><span class="ot"> class=</span><span class="st">&quot;card-body&quot;</span><span class="kw">&gt;</span></span>
<span id="cb23-4"><a href="#cb23-4"></a>    <span class="kw">&lt;h3</span><span class="ot"> class=</span><span class="st">&quot;card-title&quot;</span><span class="kw">&gt;</span>Literate Programming<span class="kw">&lt;/h3&gt;</span></span>
<span id="cb23-5"><a href="#cb23-5"></a>    <span class="kw">&lt;p</span><span class="ot"> class=</span><span class="st">&quot;card-text&quot;</span><span class="kw">&gt;</span>Write prose and code intermixed. Not just some choice snippets: **all code is included!**</span>
<span id="cb23-6"><a href="#cb23-6"></a>    This document is a rendering of a completely **self-contained Markdown** file.<span class="kw">&lt;/p&gt;</span></span>
<span id="cb23-7"><a href="#cb23-7"></a>    <span class="kw">&lt;/div&gt;</span></span>
<span id="cb23-8"><a href="#cb23-8"></a>    <span class="kw">&lt;a</span><span class="ot"> href=</span><span class="st">&quot;https://entangled.github.io/&quot;</span><span class="ot"> class=</span><span class="st">&quot;btn btn-primary mt-auto mx-4&quot;</span><span class="kw">&gt;</span>About Entangled<span class="kw">&lt;/a&gt;</span></span>
<span id="cb23-9"><a href="#cb23-9"></a>    <span class="kw">&lt;/div&gt;&lt;/div&gt;</span></span>
<span id="cb23-10"><a href="#cb23-10"></a>...</span>
<span id="cb23-11"><a href="#cb23-11"></a><span class="kw">&lt;/div&gt;&lt;/div&gt;</span></span></code></pre></div>
<div class="annotated-code">
<p><span><em>«entangled/bootstrap.py»=</em></span></p>
<div class="sourceCode" id="cb24" data-file="entangled/bootstrap.py"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb24-1"><a href="#cb24-1"></a><span class="im">from</span> panflute <span class="im">import</span> (Element, Doc, Plain, CodeBlock, Div, Str, Image, Header,</span>
<span id="cb24-2"><a href="#cb24-2"></a>                      Link, convert_text, run_filters, RawBlock, Space, LineBreak, MetaInlines)</span>
<span id="cb24-3"><a href="#cb24-3"></a><span class="im">from</span> typing <span class="im">import</span> (Optional)</span>
<span id="cb24-4"><a href="#cb24-4"></a><span class="im">from</span> pathlib <span class="im">import</span> (Path)</span>
<span id="cb24-5"><a href="#cb24-5"></a></span>
<span id="cb24-6"><a href="#cb24-6"></a><span class="im">import</span> subprocess</span>
<span id="cb24-7"><a href="#cb24-7"></a><span class="im">import</span> pkg_resources</span>
<span id="cb24-8"><a href="#cb24-8"></a><span class="im">import</span> json</span>
<span id="cb24-9"><a href="#cb24-9"></a></span>
<span id="cb24-10"><a href="#cb24-10"></a><span class="im">from</span> .typing <span class="im">import</span> (JSONType)</span>
<span id="cb24-11"><a href="#cb24-11"></a><span class="im">from</span> .tangle <span class="im">import</span> get_name</span>
<span id="cb24-12"><a href="#cb24-12"></a><span class="im">from</span> . <span class="im">import</span> annotate</span>
<span id="cb24-13"><a href="#cb24-13"></a></span>
<span id="cb24-14"><a href="#cb24-14"></a>data_path <span class="op">=</span> Path(pkg_resources.resource_filename(<span class="va">__name__</span>, <span class="st">&quot;.&quot;</span>))</span>
<span id="cb24-15"><a href="#cb24-15"></a></span>
<span id="cb24-16"><a href="#cb24-16"></a><span class="kw">def</span> parse_dhall(content: <span class="bu">str</span>, cwd: Optional[Path] <span class="op">=</span> <span class="va">None</span>) <span class="op">-&gt;</span> JSONType:</span>
<span id="cb24-17"><a href="#cb24-17"></a>    <span class="co">&quot;&quot;&quot;Takes Dhall content and parses it to JSON compatible data.&quot;&quot;&quot;</span></span>
<span id="cb24-18"><a href="#cb24-18"></a>    cwd <span class="op">=</span> cwd <span class="kw">or</span> Path(<span class="st">&quot;.&quot;</span>)</span>
<span id="cb24-19"><a href="#cb24-19"></a>    result <span class="op">=</span> subprocess.run(</span>
<span id="cb24-20"><a href="#cb24-20"></a>        [<span class="st">&quot;dhall-to-json&quot;</span>], cwd<span class="op">=</span>cwd,</span>
<span id="cb24-21"><a href="#cb24-21"></a>        <span class="bu">input</span><span class="op">=</span>content, stdout<span class="op">=</span>subprocess.PIPE,</span>
<span id="cb24-22"><a href="#cb24-22"></a>        stderr<span class="op">=</span>subprocess.PIPE, encoding<span class="op">=</span><span class="st">&quot;utf-8&quot;</span>, check<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb24-23"><a href="#cb24-23"></a>    <span class="cf">return</span> json.loads(result.stdout)</span>
<span id="cb24-24"><a href="#cb24-24"></a></span>
<span id="cb24-25"><a href="#cb24-25"></a><span class="op">&lt;&lt;</span>bootstrap<span class="op">-</span>card<span class="op">-</span>deck<span class="op">&gt;&gt;</span></span>
<span id="cb24-26"><a href="#cb24-26"></a><span class="op">&lt;&lt;</span>bootstrap<span class="op">-</span>fold<span class="op">-</span>code<span class="op">-</span>block<span class="op">&gt;&gt;</span></span>
<span id="cb24-27"><a href="#cb24-27"></a></span>
<span id="cb24-28"><a href="#cb24-28"></a><span class="kw">def</span> prepare(doc: Doc) <span class="op">-&gt;</span> Doc:</span>
<span id="cb24-29"><a href="#cb24-29"></a>    <span class="im">from</span> datetime <span class="im">import</span> date</span>
<span id="cb24-30"><a href="#cb24-30"></a>    annotate.prepare(doc)</span>
<span id="cb24-31"><a href="#cb24-31"></a></span>
<span id="cb24-32"><a href="#cb24-32"></a>    <span class="cf">if</span> <span class="st">&quot;footer&quot;</span> <span class="kw">in</span> doc.metadata:</span>
<span id="cb24-33"><a href="#cb24-33"></a>        <span class="cf">try</span>:</span>
<span id="cb24-34"><a href="#cb24-34"></a>            old_footer <span class="op">=</span> <span class="bu">list</span>(doc.metadata[<span class="st">&quot;footer&quot;</span>].content)</span>
<span id="cb24-35"><a href="#cb24-35"></a>        <span class="cf">except</span> <span class="pp">AttributeError</span>:</span>
<span id="cb24-36"><a href="#cb24-36"></a>            old_footer <span class="op">=</span> [Str(<span class="st">&quot;&quot;</span>)]</span>
<span id="cb24-37"><a href="#cb24-37"></a></span>
<span id="cb24-38"><a href="#cb24-38"></a>        <span class="cf">try</span>:</span>
<span id="cb24-39"><a href="#cb24-39"></a>            version <span class="op">=</span> doc.metadata[<span class="st">&quot;version&quot;</span>].content[<span class="dv">0</span>]</span>
<span id="cb24-40"><a href="#cb24-40"></a>        <span class="cf">except</span> (<span class="pp">AttributeError</span>, <span class="pp">KeyError</span>):</span>
<span id="cb24-41"><a href="#cb24-41"></a>            version <span class="op">=</span> Str(<span class="st">&quot;unknown&quot;</span>)</span>
<span id="cb24-42"><a href="#cb24-42"></a>       </span>
<span id="cb24-43"><a href="#cb24-43"></a>        <span class="cf">try</span>:</span>
<span id="cb24-44"><a href="#cb24-44"></a>            license <span class="op">=</span> doc.metadata[<span class="st">&quot;license&quot;</span>].content[<span class="dv">0</span>]</span>
<span id="cb24-45"><a href="#cb24-45"></a>        <span class="cf">except</span> (<span class="pp">AttributeError</span>, <span class="pp">KeyError</span>):</span>
<span id="cb24-46"><a href="#cb24-46"></a>            license <span class="op">=</span> Str(<span class="st">&quot;unknown&quot;</span>)</span>
<span id="cb24-47"><a href="#cb24-47"></a> </span>
<span id="cb24-48"><a href="#cb24-48"></a>        doc.metadata[<span class="st">&quot;footer&quot;</span>] <span class="op">=</span> MetaInlines(</span>
<span id="cb24-49"><a href="#cb24-49"></a>            Str(<span class="bu">str</span>(date.today())), Space, Str(<span class="st">&quot;—&quot;</span>), Space,</span>
<span id="cb24-50"><a href="#cb24-50"></a>            Str(<span class="st">&quot;version:&quot;</span>), Space, version, Space, Str(<span class="st">&quot;—&quot;</span>), Space,</span>
<span id="cb24-51"><a href="#cb24-51"></a>            Str(<span class="st">&quot;license:&quot;</span>), Space, license, LineBreak,</span>
<span id="cb24-52"><a href="#cb24-52"></a>            <span class="op">*</span>old_footer)</span>
<span id="cb24-53"><a href="#cb24-53"></a></span>
<span id="cb24-54"><a href="#cb24-54"></a></span>
<span id="cb24-55"><a href="#cb24-55"></a><span class="kw">def</span> main(doc: Optional[Doc] <span class="op">=</span> <span class="va">None</span>) <span class="op">-&gt;</span> <span class="va">None</span>:</span>
<span id="cb24-56"><a href="#cb24-56"></a>    run_filters([bootstrap_card_deck, bootstrap_fold_code], prepare<span class="op">=</span>prepare, doc<span class="op">=</span>doc)</span></code></pre></div>
</div>
<div class="annotated-code">
<p><span><em>«bootstrap-card-deck»=</em></span></p>
<div class="sourceCode" id="bootstrap-card-deck"><pre class="sourceCode python"><code class="sourceCode python"><span id="bootstrap-card-deck-1"><a href="#bootstrap-card-deck-1"></a><span class="kw">def</span> bootstrap_card_deck(elem: Element, doc: Doc) <span class="op">-&gt;</span> Optional[Element]:</span>
<span id="bootstrap-card-deck-2"><a href="#bootstrap-card-deck-2"></a>    <span class="kw">def</span> outer_container(<span class="op">*</span>elements: Element):</span>
<span id="bootstrap-card-deck-3"><a href="#bootstrap-card-deck-3"></a>        <span class="cf">return</span> Div(Div(<span class="op">*</span>elements, classes<span class="op">=</span>[<span class="st">&quot;card-deck&quot;</span>]), classes<span class="op">=</span>[<span class="st">&quot;container-fluid&quot;</span>, <span class="st">&quot;my-4&quot;</span>])</span>
<span id="bootstrap-card-deck-4"><a href="#bootstrap-card-deck-4"></a></span>
<span id="bootstrap-card-deck-5"><a href="#bootstrap-card-deck-5"></a>    <span class="kw">def</span> card(card_data: JSONType) <span class="op">-&gt;</span> Element:</span>
<span id="bootstrap-card-deck-6"><a href="#bootstrap-card-deck-6"></a>        <span class="cf">assert</span> <span class="st">&quot;title&quot;</span> <span class="kw">in</span> card_data <span class="kw">and</span> <span class="st">&quot;text&quot;</span> <span class="kw">in</span> card_data</span>
<span id="bootstrap-card-deck-7"><a href="#bootstrap-card-deck-7"></a>        title <span class="op">=</span> card_data[<span class="st">&quot;title&quot;</span>]</span>
<span id="bootstrap-card-deck-8"><a href="#bootstrap-card-deck-8"></a>        text <span class="op">=</span> convert_text(card_data[<span class="st">&quot;text&quot;</span>])</span>
<span id="bootstrap-card-deck-9"><a href="#bootstrap-card-deck-9"></a></span>
<span id="bootstrap-card-deck-10"><a href="#bootstrap-card-deck-10"></a>        content <span class="op">=</span> []</span>
<span id="bootstrap-card-deck-11"><a href="#bootstrap-card-deck-11"></a>        <span class="cf">if</span> <span class="st">&quot;image&quot;</span> <span class="kw">in</span> card_data:</span>
<span id="bootstrap-card-deck-12"><a href="#bootstrap-card-deck-12"></a>            content.append(Plain(Image(url<span class="op">=</span>card_data[<span class="st">&quot;image&quot;</span>], title<span class="op">=</span>title, classes<span class="op">=</span>[<span class="st">&quot;card-img-top&quot;</span>])))</span>
<span id="bootstrap-card-deck-13"><a href="#bootstrap-card-deck-13"></a></span>
<span id="bootstrap-card-deck-14"><a href="#bootstrap-card-deck-14"></a>        body <span class="op">=</span> [</span>
<span id="bootstrap-card-deck-15"><a href="#bootstrap-card-deck-15"></a>            Header(Str(title), level<span class="op">=</span><span class="dv">3</span>, classes<span class="op">=</span>[<span class="st">&quot;card-title&quot;</span>]),</span>
<span id="bootstrap-card-deck-16"><a href="#bootstrap-card-deck-16"></a>            Div(<span class="op">*</span>text, classes<span class="op">=</span>[<span class="st">&quot;card-text&quot;</span>])</span>
<span id="bootstrap-card-deck-17"><a href="#bootstrap-card-deck-17"></a>        ]</span>
<span id="bootstrap-card-deck-18"><a href="#bootstrap-card-deck-18"></a></span>
<span id="bootstrap-card-deck-19"><a href="#bootstrap-card-deck-19"></a>        <span class="cf">if</span> <span class="st">&quot;link&quot;</span> <span class="kw">in</span> card_data:</span>
<span id="bootstrap-card-deck-20"><a href="#bootstrap-card-deck-20"></a>            body.append(Plain(Link(Str(card_data[<span class="st">&quot;link&quot;</span>][<span class="st">&quot;content&quot;</span>]),</span>
<span id="bootstrap-card-deck-21"><a href="#bootstrap-card-deck-21"></a>                                   url<span class="op">=</span>card_data[<span class="st">&quot;link&quot;</span>][<span class="st">&quot;href&quot;</span>],</span>
<span id="bootstrap-card-deck-22"><a href="#bootstrap-card-deck-22"></a>                                   classes<span class="op">=</span>[<span class="st">&quot;btn&quot;</span>, <span class="st">&quot;btn-secondary&quot;</span>, <span class="st">&quot;mt-auto&quot;</span>, <span class="st">&quot;mx-4&quot;</span>])))</span>
<span id="bootstrap-card-deck-23"><a href="#bootstrap-card-deck-23"></a></span>
<span id="bootstrap-card-deck-24"><a href="#bootstrap-card-deck-24"></a>        content.append(Div(<span class="op">*</span>body, classes<span class="op">=</span>[<span class="st">&quot;card-body&quot;</span>, <span class="st">&quot;d-flex&quot;</span>, <span class="st">&quot;flex-column&quot;</span>]))</span>
<span id="bootstrap-card-deck-25"><a href="#bootstrap-card-deck-25"></a></span>
<span id="bootstrap-card-deck-26"><a href="#bootstrap-card-deck-26"></a>        content <span class="op">=</span> Div(Div(<span class="op">*</span>content, classes<span class="op">=</span>[<span class="st">&quot;card&quot;</span>, <span class="st">&quot;h-100&quot;</span>, <span class="st">&quot;rounded-lg&quot;</span>]), classes<span class="op">=</span>[<span class="st">&quot;col&quot;</span>])</span>
<span id="bootstrap-card-deck-27"><a href="#bootstrap-card-deck-27"></a>        <span class="cf">return</span> content</span>
<span id="bootstrap-card-deck-28"><a href="#bootstrap-card-deck-28"></a></span>
<span id="bootstrap-card-deck-29"><a href="#bootstrap-card-deck-29"></a>    <span class="cf">if</span> <span class="bu">isinstance</span>(elem, CodeBlock) <span class="kw">and</span> <span class="st">&quot;bootstrap-card-deck&quot;</span> <span class="kw">in</span> elem.classes:</span>
<span id="bootstrap-card-deck-30"><a href="#bootstrap-card-deck-30"></a>        content <span class="op">=</span> <span class="bu">map</span>(card, parse_dhall(elem.text, cwd<span class="op">=</span>data_path))</span>
<span id="bootstrap-card-deck-31"><a href="#bootstrap-card-deck-31"></a>        <span class="cf">return</span> outer_container(<span class="op">*</span>content)</span>
<span id="bootstrap-card-deck-32"><a href="#bootstrap-card-deck-32"></a></span>
<span id="bootstrap-card-deck-33"><a href="#bootstrap-card-deck-33"></a>    <span class="cf">return</span> <span class="va">None</span></span></code></pre></div>
</div>
<h2 id="foldable-code-blocks">Foldable code blocks</h2>
<div class="annotated-code">
<p><span><em>«bootstrap-fold-code-block»=</em></span></p>
<div class="sourceCode" id="bootstrap-fold-code-block"><pre class="sourceCode python"><code class="sourceCode python"><span id="bootstrap-fold-code-block-1"><a href="#bootstrap-fold-code-block-1"></a><span class="kw">def</span> fix_name(name: <span class="bu">str</span>) <span class="op">-&gt;</span> <span class="bu">str</span>:</span>
<span id="bootstrap-fold-code-block-2"><a href="#bootstrap-fold-code-block-2"></a>    <span class="cf">return</span> name.replace(<span class="st">&quot;.&quot;</span>, <span class="st">&quot;-dot-&quot;</span>).replace(<span class="st">&quot;/&quot;</span>, <span class="st">&quot;-slash-&quot;</span>)</span>
<span id="bootstrap-fold-code-block-3"><a href="#bootstrap-fold-code-block-3"></a></span>
<span id="bootstrap-fold-code-block-4"><a href="#bootstrap-fold-code-block-4"></a></span>
<span id="bootstrap-fold-code-block-5"><a href="#bootstrap-fold-code-block-5"></a><span class="kw">def</span> bootstrap_fold_code(elem: Element, doc: Doc) <span class="op">-&gt;</span> Optional[Element]:</span>
<span id="bootstrap-fold-code-block-6"><a href="#bootstrap-fold-code-block-6"></a>    <span class="cf">if</span> <span class="bu">isinstance</span>(elem, CodeBlock):</span>
<span id="bootstrap-fold-code-block-7"><a href="#bootstrap-fold-code-block-7"></a>        name <span class="op">=</span> get_name(elem)</span>
<span id="bootstrap-fold-code-block-8"><a href="#bootstrap-fold-code-block-8"></a>        <span class="cf">if</span> <span class="st">&quot;bootstrap-fold&quot;</span> <span class="kw">in</span> elem.classes <span class="kw">and</span> name <span class="kw">is</span> <span class="kw">not</span> <span class="va">None</span>:</span>
<span id="bootstrap-fold-code-block-9"><a href="#bootstrap-fold-code-block-9"></a>            fixed_name <span class="op">=</span> fix_name(name)</span>
<span id="bootstrap-fold-code-block-10"><a href="#bootstrap-fold-code-block-10"></a>            button_attrs <span class="op">=</span> {</span>
<span id="bootstrap-fold-code-block-11"><a href="#bootstrap-fold-code-block-11"></a>                <span class="st">&quot;class&quot;</span>: <span class="st">&quot;btn btn-outline-primary btn-sm fold-toggle&quot;</span>,</span>
<span id="bootstrap-fold-code-block-12"><a href="#bootstrap-fold-code-block-12"></a>                <span class="st">&quot;type&quot;</span>: <span class="st">&quot;button&quot;</span>,</span>
<span id="bootstrap-fold-code-block-13"><a href="#bootstrap-fold-code-block-13"></a>                <span class="st">&quot;data-toggle&quot;</span>: <span class="st">&quot;collapse&quot;</span>,</span>
<span id="bootstrap-fold-code-block-14"><a href="#bootstrap-fold-code-block-14"></a>                <span class="st">&quot;data-target&quot;</span>: <span class="st">&quot;#&quot;</span> <span class="op">+</span> fixed_name <span class="op">+</span> <span class="st">&quot;-container&quot;</span>,</span>
<span id="bootstrap-fold-code-block-15"><a href="#bootstrap-fold-code-block-15"></a>                <span class="st">&quot;aria-controls&quot;</span>: fixed_name <span class="op">+</span> <span class="st">&quot;-container&quot;</span></span>
<span id="bootstrap-fold-code-block-16"><a href="#bootstrap-fold-code-block-16"></a>            }</span>
<span id="bootstrap-fold-code-block-17"><a href="#bootstrap-fold-code-block-17"></a>            attr_str <span class="op">=</span> <span class="st">&quot; &quot;</span>.join(<span class="ss">f&quot;</span><span class="sc">{k}</span><span class="ss">=</span><span class="ch">\&quot;</span><span class="sc">{v}</span><span class="ch">\&quot;</span><span class="ss">&quot;</span> <span class="cf">for</span> k, v <span class="kw">in</span> button_attrs.items())</span>
<span id="bootstrap-fold-code-block-18"><a href="#bootstrap-fold-code-block-18"></a>            button <span class="op">=</span> RawBlock(<span class="ss">f&quot;&lt;button </span><span class="sc">{</span>attr_str<span class="sc">}</span><span class="ss">&gt;&amp;lt;&amp;lt;</span><span class="sc">{</span>name<span class="sc">}</span><span class="ss">&amp;gt;&amp;gt;=&lt;/button&gt;&quot;</span>)</span>
<span id="bootstrap-fold-code-block-19"><a href="#bootstrap-fold-code-block-19"></a>            elem.classes.append(<span class="st">&quot;overflow-auto&quot;</span>)</span>
<span id="bootstrap-fold-code-block-20"><a href="#bootstrap-fold-code-block-20"></a>            elem.attributes[<span class="st">&quot;style&quot;</span>] <span class="op">=</span> <span class="st">&quot;max-height: 50vh&quot;</span></span>
<span id="bootstrap-fold-code-block-21"><a href="#bootstrap-fold-code-block-21"></a>            <span class="cf">return</span> Div(button, Div(elem, classes<span class="op">=</span>[<span class="st">&quot;collapse&quot;</span>], identifier<span class="op">=</span>fixed_name <span class="op">+</span> <span class="st">&quot;-container&quot;</span>),</span>
<span id="bootstrap-fold-code-block-22"><a href="#bootstrap-fold-code-block-22"></a>                       classes<span class="op">=</span>[<span class="st">&quot;fold-block&quot;</span>])</span>
<span id="bootstrap-fold-code-block-23"><a href="#bootstrap-fold-code-block-23"></a></span>
<span id="bootstrap-fold-code-block-24"><a href="#bootstrap-fold-code-block-24"></a>        <span class="cf">else</span>:</span>
<span id="bootstrap-fold-code-block-25"><a href="#bootstrap-fold-code-block-25"></a>            <span class="cf">return</span> annotate.action(elem, doc)</span>
<span id="bootstrap-fold-code-block-26"><a href="#bootstrap-fold-code-block-26"></a></span>
<span id="bootstrap-fold-code-block-27"><a href="#bootstrap-fold-code-block-27"></a>    <span class="cf">return</span> <span class="va">None</span></span></code></pre></div>
</div>
</div></main>



<!-- Bootstrap 4.5.0 -->
<script src="https://code.jquery.com/jquery-3.5.1.slim.min.js" integrity="sha384-DfXdz2htPH0lsSSs5nCTpuj/zy4C+OGpamoFVy38MVBnE+IbbVYUew+OrCXaRkfj" crossorigin="anonymous"></script>
<script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.0/dist/umd/popper.min.js" integrity="sha384-Q6E9RHvbIyZFJoft+2mJbHaEWldlvI9IOYy5n3zV9zzTtmI3UksdQRVvoxMfooAo" crossorigin="anonymous"></script>
<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.0/js/bootstrap.min.js" integrity="sha384-OgVRvuATP1z7JjHLkuOU7Xw704+h835Lr+6QL9UvYjZE3Ipu6Tp75j7Bh/kR0JKI" crossorigin="anonymous"></script>

<!-- Mathjax -->
</body>
</html>
